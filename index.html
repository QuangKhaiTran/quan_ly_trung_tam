<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Lớp học và Học phí</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#eef2ff",
                100: "#e0e7ff",
                200: "#c7d2fe",
                300: "#a5b4fc",
                400: "#818cf8",
                500: "#6366f1",
                600: "#5D5CDE", // Our primary color
                700: "#4338ca",
                800: "#3730a3",
                900: "#312e81",
                950: "#1e1b4b",
              },
              secondary: {
                500: "#4F4FBB",
                600: "#4338ca",
              },
              accent: {
                500: "#7E7EE3",
              }
            },
            fontFamily: {
              sans: ['Nunito', 'sans-serif'],
            },
            boxShadow: {
              'custom': '0 4px 15px 0 rgba(0, 0, 0, 0.05)',
              'custom-lg': '0 10px 25px -5px rgba(0, 0, 0, 0.1)',
            },
          },
        },
      };

      // Check dark mode preference
      if (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches
      ) {
        document.documentElement.classList.add("dark");
      }
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (event) => {
          if (event.matches) {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        });
    </script>
    <style>
      /* Smooth scrolling */
      html {
        scroll-behavior: smooth;
      }
      
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      
      .dark ::-webkit-scrollbar-track {
        background: #1f2937;
      }
      
      ::-webkit-scrollbar-thumb {
        background: #c7d2fe;
        border-radius: 4px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: #818cf8;
      }
      
      .dark ::-webkit-scrollbar-thumb {
        background: #4338ca;
      }
      
      .dark ::-webkit-scrollbar-thumb:hover {
        background: #6366f1;
      }
      
      /* Animations */
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      /* Form focus effects */
      input:focus, select:focus, textarea:focus {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        outline: none;
      }
      
      .dark input:focus, .dark select:focus, .dark textarea:focus {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
      }
      
      /* Button hover effects */
      .btn-hover-effect {
        transition: all 0.3s ease;
      }
      
      .btn-hover-effect:hover {
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body
    class="font-sans bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-200"
  >
    <!-- Authentication Section -->
    <div id="authSection" class="min-h-screen flex items-center justify-center px-4 py-8 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-gray-900 dark:to-indigo-950">
      <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-custom-lg overflow-hidden transition-all duration-300 transform hover:shadow-xl">
        <div class="bg-gradient-to-r from-primary-600 to-purple-600 py-8 px-6 text-white text-center">
          <div class="inline-block mb-4 p-3 bg-white/20 rounded-full">
            <i class="fas fa-graduation-cap text-3xl"></i>
          </div>
          <h1 class="text-2xl font-bold">DUC TRI ENGLISH CENTER</h1>
          <p class="mt-2 text-indigo-100">Hệ thống quản lý lớp học và học phí</p>
        </div>
        
        <!-- Login Form -->
        <div id="loginForm" class="p-8 fade-in">
          <h2 class="text-xl font-bold mb-8 text-center">Đăng nhập vào hệ thống</h2>
          <div class="space-y-6">
            <div>
              <label for="loginUsername" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">Tên đăng nhập</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-user text-gray-400"></i>
                </div>
                <input type="text" id="loginUsername" class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base transition-colors duration-200" required>
              </div>
            </div>
            <div>
              <label for="loginPassword" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">Mật khẩu</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-lock text-gray-400"></i>
                </div>
                <input type="password" id="loginPassword" class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base transition-colors duration-200" required>
              </div>
            </div>
            <div id="loginError" class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 dark:bg-red-900/30 dark:text-red-400 rounded-lg hidden">
              <div class="flex">
                <div class="flex-shrink-0">
                  <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="ml-3"></div>
              </div>
            </div>
            <button id="loginBtn" class="btn-hover-effect w-full bg-gradient-to-r from-primary-600 to-purple-600 hover:from-primary-700 hover:to-purple-700 text-white py-3 px-4 rounded-lg transition-all duration-300 font-semibold flex items-center justify-center">
              <i class="fas fa-sign-in-alt mr-2"></i> Đăng nhập
            </button>
            <p class="text-center text-gray-600 dark:text-gray-400">
              Chưa có tài khoản? 
              <a href="#" id="showRegisterBtn" class="text-primary-600 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-300 font-semibold transition-colors duration-200">Đăng ký ngay</a>
            </p>
          </div>
        </div>
        
        <!-- Registration Form -->
        <div id="registerForm" class="p-8 hidden fade-in">
          <h2 class="text-xl font-bold mb-8 text-center">Đăng ký tài khoản mới</h2>
          <div class="space-y-6">
            <div>
              <label for="registerUsername" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">Tên đăng nhập</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-user text-gray-400"></i>
                </div>
                <input type="text" id="registerUsername" class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base transition-colors duration-200" required>
              </div>
            </div>
            <div>
              <label for="registerPassword" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">Mật khẩu</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-lock text-gray-400"></i>
                </div>
                <input type="password" id="registerPassword" class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base transition-colors duration-200" required>
              </div>
            </div>
            <div>
              <label for="securityCode" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">Mã bảo vệ</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-shield-alt text-gray-400"></i>
                </div>
                <input type="password" id="securityCode" class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base transition-colors duration-200" required>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 ml-2">Liên hệ quản trị viên để nhận mã bảo vệ</p>
              </div>
            </div>
            <div id="registerError" class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 dark:bg-red-900/30 dark:text-red-400 rounded-lg hidden">
              <div class="flex">
                <div class="flex-shrink-0">
                  <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="ml-3"></div>
              </div>
            </div>
            <button id="registerBtn" class="btn-hover-effect w-full bg-gradient-to-r from-primary-600 to-purple-600 hover:from-primary-700 hover:to-purple-700 text-white py-3 px-4 rounded-lg transition-all duration-300 font-semibold flex items-center justify-center">
              <i class="fas fa-user-plus mr-2"></i> Đăng ký
            </button>
            <p class="text-center text-gray-600 dark:text-gray-400">
              Đã có tài khoản? 
              <a href="#" id="showLoginBtn" class="text-primary-600 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-300 font-semibold transition-colors duration-200">Đăng nhập</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <div id="appSection" class="min-h-screen flex flex-col hidden">
      <!-- Header -->
      <header class="bg-gradient-to-r from-primary-600 to-indigo-700 text-white shadow-md py-4 px-6 sticky top-0 z-50">
        <div
          class="container mx-auto flex justify-between items-center flex-wrap"
        >
          <div class="flex items-center">
            <div class="p-2 bg-white/10 rounded-full mr-3">
              <i class="fas fa-graduation-cap text-xl"></i>
            </div>
            <h1 class="text-2xl font-bold">DUC TRI ENGLISH CENTER</h1>
          </div>
          <div class="flex items-center space-x-3">
            <nav class="flex space-x-1 mt-2 sm:mt-0 flex-wrap">
              <button
                id="navClassBtn"
                class="py-2 px-4 rounded-lg hover:bg-white/20 transition-colors flex items-center"
              >
                <i class="fas fa-chalkboard-teacher mr-2"></i> Lớp học
              </button>
              <button
                id="navStudentBtn"
                class="py-2 px-4 rounded-lg hover:bg-white/20 transition-colors flex items-center"
              >
                <i class="fas fa-user-graduate mr-2"></i> Học sinh
              </button>
              <button
                id="navFeeBtn"
                class="py-2 px-4 rounded-lg hover:bg-white/20 transition-colors flex items-center"
              >
                <i class="fas fa-money-bill-wave mr-2"></i> Học phí
              </button>
              <button
                id="navReportBtn"
                class="py-2 px-4 rounded-lg hover:bg-white/20 transition-colors flex items-center"
              >
                <i class="fas fa-chart-bar mr-2"></i> Báo cáo
              </button>
            </nav>
            <div class="h-8 w-px bg-white/20"></div>
            <button
              id="logoutBtn"
              class="btn-hover-effect py-2 px-4 bg-red-600/80 hover:bg-red-700 rounded-lg transition-colors flex items-center"
            >
              <i class="fas fa-sign-out-alt mr-2"></i> Đăng xuất
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="flex-grow container mx-auto p-4 md:p-6">
        <!-- Class Management Section -->
        <section
          id="classSection"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-custom p-6 mb-8 fade-in"
        >
          <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
            <div class="flex items-center">
              <div class="p-2 bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full mr-3">
                <i class="fas fa-chalkboard-teacher text-xl"></i>
              </div>
              <h2 class="text-xl font-bold">Quản lý Lớp học</h2>
            </div>
            <div class="flex gap-3 flex-wrap">
              <button
                id="addClassBtn"
                class="btn-hover-effect bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm"
              >
                <i class="fas fa-plus mr-2"></i> Thêm lớp học
              </button>
              <button
                id="archivedClassesBtn"
                class="btn-hover-effect bg-gray-600 hover:bg-gray-700 text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm"
              >
                <i class="fas fa-archive mr-2"></i> Lớp đã lưu trữ
              </button>
            </div>
          </div>

          <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <table
              class="min-w-full bg-white dark:bg-gray-800"
            >
              <thead>
                <tr class="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
                  <th class="py-3 px-4 text-left font-semibold">STT</th>
                  <th class="py-3 px-4 text-left font-semibold">Tên lớp</th>
                  <th class="py-3 px-4 text-left font-semibold">Khối</th>
                  <th class="py-3 px-4 text-left font-semibold">Giáo viên</th>
                  <th class="py-3 px-4 text-left font-semibold">Lịch học</th>
                  <th class="py-3 px-4 text-left font-semibold">Học phí</th>
                  <th class="py-3 px-4 text-left font-semibold">Ngày bắt đầu</th>
                  <th class="py-3 px-4 text-left font-semibold">Thao tác</th>
                </tr>
              </thead>
              <tbody id="classTableBody">
                <tr>
                  <td colspan="8" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                    <div class="flex flex-col items-center">
                      <i class="fas fa-folder-open text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                      Chưa có lớp học nào. Hãy thêm lớp học mới!
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Archived Classes Section -->
        <section
          id="archivedClassesSection"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-custom p-6 mb-8 hidden fade-in"
        >
          <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
            <div class="flex items-center">
              <div class="p-2 bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 rounded-full mr-3">
                <i class="fas fa-archive text-xl"></i>
              </div>
              <h2 class="text-xl font-bold">Lớp học đã lưu trữ</h2>
            </div>
            <button
              id="backToClassesBtn"
              class="btn-hover-effect bg-gray-500 hover:bg-gray-600 text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm"
            >
              <i class="fas fa-arrow-left mr-2"></i> Quay lại
            </button>
          </div>

          <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <table
              class="min-w-full bg-white dark:bg-gray-800"
            >
              <thead>
                <tr class="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
                  <th class="py-3 px-4 text-left font-semibold">STT</th>
                  <th class="py-3 px-4 text-left font-semibold">Tên lớp</th>
                  <th class="py-3 px-4 text-left font-semibold">Khối</th>
                  <th class="py-3 px-4 text-left font-semibold">Giáo viên</th>
                  <th class="py-3 px-4 text-left font-semibold">Lịch học</th>
                  <th class="py-3 px-4 text-left font-semibold">Học phí</th>
                  <th class="py-3 px-4 text-left font-semibold">Ngày bắt đầu</th>
                  <th class="py-3 px-4 text-left font-semibold">Thao tác</th>
                </tr>
              </thead>
              <tbody id="archivedClassTableBody">
                <tr>
                  <td colspan="8" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                    <div class="flex flex-col items-center">
                      <i class="fas fa-box-archive text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                      Chưa có lớp học nào được lưu trữ.
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Class Detail Section -->
        <section
          id="classDetailSection"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-custom p-6 mb-8 hidden fade-in"
        >
          <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
            <div>
              <h2 class="text-xl font-bold mb-2 flex items-center">
                <span class="p-2 bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full mr-3">
                  <i class="fas fa-users text-xl"></i>
                </span>
                Danh sách học sinh lớp <span id="classDetailName" class="ml-2 text-primary-600 dark:text-primary-400">-</span>
              </h2>
              <div class="flex flex-wrap gap-x-8 gap-y-2 text-gray-600 dark:text-gray-400 ml-12 text-sm">
                <p class="flex items-center">
                  <i class="fas fa-chalkboard-teacher mr-2"></i> Giáo viên: <span id="classDetailTeacher" class="font-medium ml-1">-</span>
                </p>
                <p class="flex items-center">
                  <i class="fas fa-calendar-alt mr-2"></i> Lịch học: <span id="classDetailSchedule" class="font-medium ml-1">-</span>
                </p>
              </div>
            </div>
            <div class="flex gap-3 flex-wrap">
              <button
                id="addStudentToClassBtn"
                class="btn-hover-effect bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm"
              >
                <i class="fas fa-user-plus mr-2"></i> Thêm học sinh vào lớp
              </button>
              <button
                id="printClassStudentsBtn"
                class="btn-hover-effect bg-green-600 hover:bg-green-700 text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm"
              >
                <i class="fas fa-print mr-2"></i> In danh sách
              </button>
              <button
                id="exportExcelBtn"
                class="btn-hover-effect bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm"
              >
                <i class="fas fa-file-excel mr-2"></i> Xuất Excel
              </button>
              <button
                id="backToClassesListBtn"
                class="btn-hover-effect bg-gray-500 hover:bg-gray-600 text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm"
              >
                <i class="fas fa-arrow-left mr-2"></i> Quay lại
              </button>
            </div>
          </div>

          <!-- Search Bar for Class Students -->
          <div class="mb-6">
            <div class="relative max-w-md">
              <input
                type="text"
                id="classStudentSearchInput"
                placeholder="Tìm kiếm học sinh trong lớp..."
                class="w-full p-3 pl-12 pr-10 rounded-lg border dark:bg-gray-700 dark:border-gray-600 text-base shadow-sm focus:ring-2 focus:ring-primary-500/30 transition-all duration-200"
              />
              <i
                class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
              ></i>
            </div>
          </div>

          <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-6">
            <table
              class="min-w-full bg-white dark:bg-gray-800"
            >
              <thead>
                <tr class="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
                  <th class="py-3 px-4 text-left font-semibold">STT</th>
                  <th class="py-3 px-4 text-left font-semibold">Họ và tên</th>
                  <th class="py-3 px-4 text-left font-semibold">Khối</th>
                  <th class="py-3 px-4 text-left font-semibold">Số điện thoại</th>
                  <th class="py-3 px-4 text-left font-semibold">Tình trạng</th>
                  <th class="py-3 px-4 text-left font-semibold">
                    Trạng thái học phí
                  </th>
                  <th class="py-3 px-4 text-left font-semibold">Thao tác</th>
                </tr>
              </thead>
              <tbody id="classStudentsTableBody">
                <tr>
                  <td colspan="7" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                    <div class="flex flex-col items-center">
                      <i class="fas fa-user-graduate text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                      Chưa có học sinh nào trong lớp này
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-5 rounded-xl shadow-sm border border-blue-100 dark:border-blue-900/50">
              <div class="flex items-center mb-1">
                <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-800/50 flex items-center justify-center text-blue-500 dark:text-blue-300 mr-3">
                  <i class="fas fa-users"></i>
                </div>
                <p class="font-bold">Tổng số học sinh</p>
              </div>
              <p id="totalStudentsCount" class="text-3xl font-bold text-blue-600 dark:text-blue-400 mt-2">0</p>
            </div>
            <div class="bg-green-50 dark:bg-green-900/20 p-5 rounded-xl shadow-sm border border-green-100 dark:border-green-900/50">
              <div class="flex items-center mb-1">
                <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-800/50 flex items-center justify-center text-green-500 dark:text-green-300 mr-3">
                  <i class="fas fa-check-circle"></i>
                </div>
                <p class="font-bold">Đã đóng học phí</p>
              </div>
              <p id="paidStudentsCount" class="text-3xl font-bold text-green-600 dark:text-green-400 mt-2">0</p>
            </div>
            <div class="bg-red-50 dark:bg-red-900/20 p-5 rounded-xl shadow-sm border border-red-100 dark:border-red-900/50">
              <div class="flex items-center mb-1">
                <div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-800/50 flex items-center justify-center text-red-500 dark:text-red-300 mr-3">
                  <i class="fas fa-exclamation-circle"></i>
                </div>
                <p class="font-bold">Chưa đóng học phí</p>
              </div>
              <p id="unpaidStudentsCount" class="text-3xl font-bold text-red-600 dark:text-red-400 mt-2">0</p>
            </div>
            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-5 rounded-xl shadow-sm border border-yellow-100 dark:border-yellow-900/50">
              <div class="flex items-center mb-1">
                <div class="w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-800/50 flex items-center justify-center text-yellow-500 dark:text-yellow-300 mr-3">
                  <i class="fas fa-pause-circle"></i>
                </div>
                <p class="font-bold">Tạm nghỉ/Nghỉ học</p>
              </div>
              <p id="inactiveStudentsCount" class="text-3xl font-bold text-yellow-600 dark:text-yellow-400 mt-2">0</p>
            </div>
          </div>
        </section>

        <!-- Student Management Section -->
        <section
          id="studentSection"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-custom p-6 mb-8 hidden fade-in"
        >
          <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
            <div class="flex items-center">
              <div class="p-2 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-full mr-3">
                <i class="fas fa-user-graduate text-xl"></i>
              </div>
              <h2 class="text-xl font-bold">Quản lý Học sinh</h2>
            </div>
            <div class="flex gap-3 flex-wrap">
              <button
                id="addStudentBtn"
                class="btn-hover-effect bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm"
              >
                <i class="fas fa-user-plus mr-2"></i> Thêm học sinh
              </button>
              <button
                id="importStudentsBtn"
                class="btn-hover-effect bg-green-600 hover:bg-green-700 text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm"
              >
                <i class="fas fa-file-import mr-2"></i> Import học sinh
              </button>
              <button
                id="exportAllStudentsBtn"
                class="btn-hover-effect bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm"
              >
                <i class="fas fa-file-excel mr-2"></i> Xuất Excel
              </button>
            </div>
          </div>

          <div class="mb-6">
            <div class="relative max-w-lg mx-auto">
              <input
                type="text"
                id="studentSearchInput"
                placeholder="Tìm kiếm học sinh theo tên, khối hoặc số điện thoại..."
                class="w-full p-3 pl-12 pr-10 rounded-full border dark:bg-gray-700 dark:border-gray-600 text-base shadow-sm focus:ring-2 focus:ring-primary-500/30 transition-all duration-200"
              />
              <i
                class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
              ></i>
              <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                <div class="h-6 px-2 py-1 bg-gray-100 dark:bg-gray-600 rounded-full text-xs text-gray-600 dark:text-gray-300 flex items-center">
                  <i class="fas fa-keyboard mr-1"></i> Enter
                </div>
              </div>
            </div>
          </div>

          <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <table
              class="min-w-full bg-white dark:bg-gray-800"
            >
              <thead>
                <tr class="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
                  <th class="py-3 px-4 text-left font-semibold">STT</th>
                  <th class="py-3 px-4 text-left font-semibold">Họ và tên</th>
                  <th class="py-3 px-4 text-left font-semibold">Khối</th>
                  <th class="py-3 px-4 text-left font-semibold">Số điện thoại</th>
                  <th class="py-3 px-4 text-left font-semibold">Tình trạng</th>
                  <th class="py-3 px-4 text-left font-semibold">
                    Lớp học đã đăng ký
                  </th>
                  <th class="py-3 px-4 text-left font-semibold">Thao tác</th>
                </tr>
              </thead>
              <tbody id="studentTableBody">
                <tr>
                  <td colspan="7" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                    <div class="flex flex-col items-center">
                      <i class="fas fa-user-graduate text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                      Chưa có học sinh nào. Hãy thêm học sinh mới!
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Fee Management Section -->
        <section
          id="feeSection"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-custom p-6 mb-8 hidden fade-in"
        >
          <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
            <div class="flex items-center">
              <div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-full mr-3">
                <i class="fas fa-money-bill-wave text-xl"></i>
              </div>
              <h2 class="text-xl font-bold">Thu học phí</h2>
            </div>
            <div class="flex-grow max-w-lg">
              <div class="relative">
                <input
                  type="text"
                  id="feeStudentSearchInput"
                  placeholder="Tìm kiếm học sinh theo tên, khối hoặc số điện thoại..."
                  class="w-full p-3 pl-12 rounded-lg border dark:bg-gray-700 dark:border-gray-600 text-base shadow-sm focus:ring-2 focus:ring-primary-500/30 transition-all duration-200"
                />
                <i
                  class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                ></i>
                <button
                  id="searchFeeStudentBtn"
                  class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-primary-600 hover:bg-primary-700 text-white py-1.5 px-4 rounded-lg transition-colors btn-hover-effect shadow-sm"
                >
                  <i class="fas fa-search mr-1"></i> Tìm kiếm
                </button>
              </div>
            </div>
          </div>

          <div id="feeSearchResults" class="mb-8 hidden">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
              <i class="fas fa-search text-primary-500 mr-2"></i> Kết quả tìm kiếm:
            </h3>
            <div
              id="feeStudentList"
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
            ></div>
          </div>

          <div class="mt-8">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
              <i class="fas fa-history text-primary-500 mr-2"></i> Giao dịch gần đây
            </h3>
            <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
              <table
                class="min-w-full bg-white dark:bg-gray-800"
              >
                <thead>
                  <tr class="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
                    <th class="py-3 px-4 text-left font-semibold">Mã biên lai</th>
                    <th class="py-3 px-4 text-left font-semibold">Ngày</th>
                    <th class="py-3 px-4 text-left font-semibold">Học sinh</th>
                    <th class="py-3 px-4 text-left font-semibold">Lớp học</th>
                    <th class="py-3 px-4 text-left font-semibold">Số tiền</th>
                    <th class="py-3 px-4 text-left font-semibold">Thao tác</th>
                  </tr>
                </thead>
                <tbody id="transactionsTableBody">
                  <tr>
                    <td colspan="6" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                      <div class="flex flex-col items-center">
                        <i class="fas fa-receipt text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                        Chưa có giao dịch nào.
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Report Section -->
        <section
          id="reportSection"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-custom p-6 mb-8 hidden fade-in"
        >
          <div class="flex flex-wrap justify-between items-center mb-8">
            <div class="flex items-center mb-4 md:mb-0">
            <div class="p-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-full mr-3">
              <i class="fas fa-chart-bar text-xl"></i>
            </div>
            <h2 class="text-xl font-bold">Báo cáo tài chính</h2>
          </div>

            <!-- Month/Year filter -->
            <div class="flex items-center space-x-4">
              <div class="flex items-center">
                <label for="reportMonth" class="mr-2 text-gray-700 dark:text-gray-300 font-medium">Tháng:</label>
                <select id="reportMonth" class="p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base appearance-none bg-no-repeat" 
                  style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path fill=\"none\" d=\"M0 0h24v24H0z\"/><path d=\"M12 15l-4.243-4.243 1.415-1.414L12 12.172l2.828-2.829 1.415 1.414z\"/></svg>'); background-position: right 0.5rem center; padding-right: 2rem;">
                </select>
              </div>
              <div class="flex items-center">
                <label for="reportYear" class="mr-2 text-gray-700 dark:text-gray-300 font-medium">Năm:</label>
                <select id="reportYear" class="p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base appearance-none bg-no-repeat"
                  style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path fill=\"none\" d=\"M0 0h24v24H0z\"/><path d=\"M12 15l-4.243-4.243 1.415-1.414L12 12.172l2.828-2.829 1.415 1.414z\"/></svg>'); background-position: right 0.5rem center; padding-right: 2rem;">
                </select>
              </div>
              <button id="applyReportFilter" class="btn-hover-effect bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white py-2 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm">
                <i class="fas fa-filter mr-2"></i> Lọc
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-r from-blue-500/10 to-blue-600/10 dark:from-blue-500/5 dark:to-blue-600/5 p-6 rounded-xl shadow-sm border border-blue-100 dark:border-blue-900/30">
              <div class="flex items-center mb-2">
                <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-800/50 flex items-center justify-center text-blue-500 dark:text-blue-300 mr-4">
                  <i class="fas fa-coins text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-blue-700 dark:text-blue-400">Tổng thu học phí</h3>
              </div>
              <p id="totalIncome" class="text-3xl font-bold text-blue-700 dark:text-blue-300 mt-3">0 VNĐ</p>
              <p class="text-blue-500 dark:text-blue-400 text-sm mt-3 flex items-center">
                <i class="fas fa-info-circle mr-1"></i> Học phí thu được trong kỳ
              </p>
            </div>
            <div class="bg-gradient-to-r from-teal-500/10 to-teal-600/10 dark:from-teal-500/5 dark:to-teal-600/5 p-6 rounded-xl shadow-sm border border-teal-100 dark:border-teal-900/30">
              <div class="flex items-center mb-2">
                <div class="w-12 h-12 rounded-full bg-teal-100 dark:bg-teal-800/50 flex items-center justify-center text-teal-500 dark:text-teal-300 mr-4">
                  <i class="fas fa-plus-circle text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-teal-700 dark:text-teal-400">Thu khác</h3>
              </div>
              <p id="additionalIncome" class="text-3xl font-bold text-teal-700 dark:text-teal-300 mt-3">0 VNĐ</p>
              <p class="text-teal-500 dark:text-teal-400 text-sm mt-3 flex items-center">
                <i class="fas fa-info-circle mr-1"></i> Khoản thu bổ sung
              </p>
            </div>
            <div class="bg-gradient-to-r from-red-500/10 to-red-600/10 dark:from-red-500/5 dark:to-red-600/5 p-6 rounded-xl shadow-sm border border-red-100 dark:border-red-900/30">
              <div class="flex items-center mb-2">
                <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-800/50 flex items-center justify-center text-red-500 dark:text-red-300 mr-4">
                  <i class="fas fa-file-invoice-dollar text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-red-700 dark:text-red-400">Tổng chi</h3>
              </div>
              <p id="totalExpenses" class="text-3xl font-bold text-red-700 dark:text-red-300 mt-3">0 VNĐ</p>
              <p class="text-red-500 dark:text-red-400 text-sm mt-3 flex items-center">
                <i class="fas fa-info-circle mr-1"></i> Giáo viên + chi phí khác
              </p>
            </div>
            <div class="bg-gradient-to-r from-green-500/10 to-green-600/10 dark:from-green-500/5 dark:to-green-600/5 p-6 rounded-xl shadow-sm border border-green-100 dark:border-green-900/30">
              <div class="flex items-center mb-2">
                <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-800/50 flex items-center justify-center text-green-500 dark:text-green-300 mr-4">
                  <i class="fas fa-chart-line text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-green-700 dark:text-green-400">Lợi nhuận</h3>
              </div>
              <p id="totalProfit" class="text-3xl font-bold text-green-700 dark:text-green-300 mt-3">0 VNĐ</p>
              <p class="text-green-500 dark:text-green-400 text-sm mt-3 flex items-center">
                <i class="fas fa-info-circle mr-1"></i> Tổng thu - Tổng chi
              </p>
            </div>
          </div>

          <!-- Additional Income/Expense Section -->
          <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold flex items-center">
                <i class="fas fa-file-invoice-dollar text-primary-500 mr-2"></i> Thu chi bổ sung
              </h3>
              <button id="addIncomeExpenseBtn" class="btn-hover-effect bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white py-2 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm">
                <i class="fas fa-plus mr-2"></i> Thêm khoản thu chi
              </button>
            </div>
            
            <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-4">
              <table class="min-w-full bg-white dark:bg-gray-800">
                <thead>
                  <tr class="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
                    <th class="py-3 px-4 text-left font-semibold">Ngày</th>
                    <th class="py-3 px-4 text-left font-semibold">Mô tả</th>
                    <th class="py-3 px-4 text-left font-semibold">Loại</th>
                    <th class="py-3 px-4 text-left font-semibold">Số tiền</th>
                    <th class="py-3 px-4 text-left font-semibold">Thao tác</th>
                  </tr>
                </thead>
                <tbody id="incomeExpenseTableBody">
                  <tr>
                    <td colspan="5" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                      <div class="flex flex-col items-center">
                        <i class="fas fa-file-invoice-dollar text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                        Chưa có khoản thu chi bổ sung.
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <h3 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fas fa-chart-pie text-primary-500 mr-2"></i> Hiệu suất các lớp học
          </h3>
          <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-8">
            <table
              class="min-w-full bg-white dark:bg-gray-800"
            >
              <thead>
                <tr class="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
                  <th class="py-3 px-4 text-left font-semibold">Tên lớp</th>
                  <th class="py-3 px-4 text-left font-semibold">Giáo viên</th>
                  <th class="py-3 px-4 text-left font-semibold">Học viên</th>
                  <th class="py-3 px-4 text-left font-semibold">Đã đóng phí</th>
                  <th class="py-3 px-4 text-left font-semibold">Tổng thu</th>
                  <th class="py-3 px-4 text-left font-semibold">Chi phí GV</th>
                  <th class="py-3 px-4 text-left font-semibold">Lợi nhuận</th>
                </tr>
              </thead>
              <tbody id="classPerformanceTableBody">
                <tr>
                  <td colspan="7" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                    <div class="flex flex-col items-center">
                      <i class="fas fa-chart-bar text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                      Chưa có dữ liệu lớp học.
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <h3 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fas fa-money-check-alt text-primary-500 mr-2"></i> Trạng thái đóng học phí
          </h3>
          <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <table
              class="min-w-full bg-white dark:bg-gray-800"
            >
              <thead>
                <tr class="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
                  <th class="py-3 px-4 text-left font-semibold">Lớp học</th>
                  <th class="py-3 px-4 text-left font-semibold">Học sinh</th>
                  <th class="py-3 px-4 text-left font-semibold">Trạng thái</th>
                  <th class="py-3 px-4 text-left font-semibold">Ngày đóng</th>
                  <th class="py-3 px-4 text-left font-semibold">Số tiền</th>
                </tr>
              </thead>
              <tbody id="feeStatusTableBody">
                <tr>
                  <td colspan="5" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                    <div class="flex flex-col items-center">
                      <i class="fas fa-receipt text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                      Chưa có dữ liệu học phí.
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </main>

      <!-- Footer -->
      <footer
        class="bg-gray-50 dark:bg-gray-800 py-6 px-6 text-center text-sm text-gray-600 dark:text-gray-400 mt-auto border-t border-gray-200 dark:border-gray-700"
      >
        <p class="mb-1">© 2025 - ĐỨC TRÍ ENGLISH CENTER</p>
        <p class="text-xs">Bản quyền thuộc về Khaitran2210</p>
      </footer>

      <!-- Loading Overlay -->
      <div
        id="loadingOverlay"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden"
      >
        <div
          class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg text-center"
        >
          <div
            class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary-600 mx-auto mb-6"
          ></div>
          <p class="text-lg">Đang xử lý...</p>
        </div>
      </div>

      <!-- Toast Notification -->
      <div
        id="toastNotification"
        class="fixed bottom-6 right-6 px-5 py-4 rounded-lg shadow-custom-lg transform translate-y-20 opacity-0 transition-all duration-500 z-50 flex items-center"
      >
        <div id="toastIcon" class="mr-3 text-xl"></div>
        <p id="toastMessage" class="font-medium">Thông báo</p>
      </div>

      <!-- Modals -->
      <!-- Add/Edit Class Modal -->
      <div
        id="classModal"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden"
      >
        <div
          class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-custom-lg w-full max-w-lg max-h-[90vh] overflow-y-auto transform transition-all duration-300 fade-in"
        >
          <div class="flex justify-between items-center mb-6">
            <h3 id="classModalTitle" class="text-xl font-bold flex items-center">
              <div class="p-2 bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full mr-3">
                <i class="fas fa-chalkboard-teacher"></i>
              </div>
              Thêm lớp học
            </h3>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" id="cancelClassBtnX">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <form id="classForm" class="space-y-5">
            <input type="hidden" id="classId" />
            <div>
              <label for="className" class="block mb-2 font-medium text-gray-700 dark:text-gray-300"
                >Tên lớp <span class="text-red-500">*</span></label
              >
              <input
                type="text"
                id="className"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                required
              />
            </div>
            <div>
              <label for="classGrade" class="block mb-2 font-medium text-gray-700 dark:text-gray-300"
                >Khối lớp <span class="text-red-500">*</span></label
              >
              <input
                type="text"
                id="classGrade"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                placeholder="Nhập khối lớp (VD: Lớp 10, 11A, IELTS...)"
                required
              />
            </div>
            <div>
              <label for="classTeacher" class="block mb-2 font-medium text-gray-700 dark:text-gray-300"
                >Giáo viên <span class="text-red-500">*</span></label
              >
              <input
                type="text"
                id="classTeacher"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                required
              />
            </div>
            <div>
              <label for="classStartDate" class="block mb-2 font-medium text-gray-700 dark:text-gray-300"
                >Ngày bắt đầu <span class="text-red-500">*</span></label
              >
              <input
                type="date"
                id="classStartDate"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                required
              />
            </div>
            <div>
              <label for="classSchedule" class="block mb-2 font-medium text-gray-700 dark:text-gray-300"
                >Lịch học</label
              >
              <input
                type="text"
                id="classSchedule"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                placeholder="Ví dụ: Thứ 2, 4, 6 (18:00 - 20:00)"
              />
            </div>
            <div>
              <label for="classFee" class="block mb-2 font-medium text-gray-700 dark:text-gray-300"
                >Học phí (VNĐ) <span class="text-red-500">*</span></label
              >
              <input
                type="number"
                id="classFee"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                required
              />
            </div>
            <div>
              <label for="classTeacherFee" class="block mb-2 font-medium text-gray-700 dark:text-gray-300"
                >Tiền giáo viên (VNĐ)</label
              >
              <input
                type="number"
                id="classTeacherFee"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
              />
            </div>
            <div class="flex justify-end gap-3 pt-2">
              <button
                type="button"
                id="cancelClassBtn"
                class="py-3 px-5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
              >
                Hủy
              </button>
              <button
                type="submit"
                class="py-3 px-5 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white rounded-lg transition-colors shadow-sm"
              >
                <i class="fas fa-save mr-2"></i> Lưu lại
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Add Student Modal -->
      <div
        id="studentModal"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden"
      >
        <div
          class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-custom-lg w-full max-w-lg max-h-[90vh] overflow-y-auto transform transition-all duration-300 fade-in"
        >
          <div class="flex justify-between items-center mb-6">
            <h3 id="studentModalTitle" class="text-xl font-bold flex items-center">
              <div class="p-2 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-full mr-3">
                <i class="fas fa-user-graduate"></i>
              </div>
              Thêm học sinh
            </h3>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" id="cancelStudentBtnX">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <form id="studentForm" class="space-y-5">
            <input type="hidden" id="studentId" />
            <div>
              <label for="studentName" class="block mb-2 font-medium text-gray-700 dark:text-gray-300"
                >Họ và tên <span class="text-red-500">*</span></label
              >
              <input
                type="text"
                id="studentName"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                required
              />
            </div>
            <div>
              <label for="studentGrade" class="block mb-2 font-medium text-gray-700 dark:text-gray-300"
                >Khối lớp <span class="text-red-500">*</span></label
              >
              <input
                type="text"
                id="studentGrade"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                placeholder="Nhập khối lớp (VD: Lớp 10, 11A, IELTS...)"
                required
              />
            </div>
            <div>
              <label for="studentPhone" class="block mb-2 font-medium text-gray-700 dark:text-gray-300"
                >Số điện thoại</label
              >
              <input
                type="text"
                id="studentPhone"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                placeholder="Số điện thoại học sinh hoặc phụ huynh"
              />
            </div>
            <div>
              <label for="studentStatus" class="block mb-2 font-medium text-gray-700 dark:text-gray-300"
                >Tình trạng <span class="text-red-500">*</span></label
              >
              <select
                id="studentStatus"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base appearance-none bg-no-repeat"
                style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path fill=\"none\" d=\"M0 0h24v24H0z\"/><path d=\"M12 15l-4.243-4.243 1.415-1.414L12 12.172l2.828-2.829 1.415 1.414z\"/></svg>'); background-position: right 1rem center; padding-right: 2.5rem;"
                required
              >
                <option value="đang học">Đang học</option>
                <option value="tạm nghỉ">Tạm nghỉ</option>
                <option value="đã nghỉ học">Đã nghỉ học</option>
              </select>
            </div>
            <div>
              <label for="studentClasses" class="block mb-2 font-medium text-gray-700 dark:text-gray-300"
                >Lớp học</label
              >
              <select
                id="studentClasses"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                multiple
                size="4"
              >
                <option value="">-- Chọn lớp học --</option>
              </select>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 flex items-center">
                <i class="fas fa-info-circle mr-1"></i> 
                Giữ Ctrl hoặc Cmd để chọn nhiều lớp
              </p>
            </div>
            <div class="flex justify-end gap-3 pt-2">
              <button
                type="button"
                id="cancelStudentBtn"
                class="py-3 px-5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
              >
                Hủy
              </button>
              <button
                type="submit"
                class="py-3 px-5 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white rounded-lg transition-colors shadow-sm"
              >
                <i class="fas fa-save mr-2"></i> Lưu lại
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Import Students Modal -->
      <div
        id="importStudentsModal"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden"
      >
        <div
          class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-custom-lg w-full max-w-lg transform transition-all duration-300 fade-in"
        >
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold flex items-center">
              <div class="p-2 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-full mr-3">
                <i class="fas fa-file-import"></i>
              </div>
              Import danh sách học sinh
            </h3>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" id="cancelImportBtnX">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="mb-6 p-4 border border-dashed rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50">
            <p class="mb-2 text-gray-700 dark:text-gray-300 flex items-center">
              <i class="fas fa-info-circle text-blue-500 mr-2"></i>
              Nhập danh sách học sinh theo định dạng:
            </p>
            <pre class="p-3 bg-gray-100 dark:bg-gray-700 rounded text-sm overflow-x-auto">Tên học sinh, Khối lớp, Số điện thoại (tùy chọn)</pre>
            <p class="mt-2 text-gray-500 dark:text-gray-400 text-sm">Mỗi học sinh một dòng. Ví dụ: Nguyễn Văn A, Lớp 5, 0912345678</p>
          </div>
          <div class="mb-6">
            <label for="importData" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">
              Dữ liệu
            </label>
            <textarea
              id="importData"
              rows="8"
              class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base resize-none"
              placeholder="Nhập danh sách học sinh..."
            ></textarea>
          </div>
          <div class="flex justify-end gap-3">
            <button
              type="button"
              id="cancelImportBtn"
              class="py-3 px-5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
            >
              Hủy
            </button>
            <button
              type="button"
              id="processImportBtn"
              class="py-3 px-5 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white rounded-lg transition-colors shadow-sm"
            >
              <i class="fas fa-file-import mr-2"></i> Xử lý
            </button>
          </div>
        </div>
      </div>

      <!-- Add Student to Class Modal -->
      <div
        id="addStudentToClassModal"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden"
      >
        <div
          class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-custom-lg w-full max-w-md transform transition-all duration-300 fade-in"
        >
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold flex items-center">
              <div class="p-2 bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full mr-3">
                <i class="fas fa-user-plus"></i>
              </div>
              Thêm học sinh vào lớp
            </h3>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" id="cancelAddStudentToClassBtnX">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="mb-6">
            <label for="studentToAddSelect" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">
              Chọn học sinh
            </label>
            <select
              id="studentToAddSelect"
              class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base appearance-none bg-no-repeat"
              style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path fill=\"none\" d=\"M0 0h24v24H0z\"/><path d=\"M12 15l-4.243-4.243 1.415-1.414L12 12.172l2.828-2.829 1.415 1.414z\"/></svg>'); background-position: right 1rem center; padding-right: 2.5rem;"
            >
              <option value="">-- Chọn học sinh --</option>
            </select>
          </div>
          <div class="flex justify-end gap-3">
            <button
              type="button"
              id="cancelAddStudentToClassBtn"
              class="py-3 px-5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
            >
              Hủy
            </button>
            <button
              type="button"
              id="confirmAddStudentToClassBtn"
              class="py-3 px-5 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white rounded-lg transition-colors shadow-sm"
            >
              <i class="fas fa-user-plus mr-2"></i> Thêm
            </button>
          </div>
        </div>
      </div>

      <!-- Update Student Status Modal -->
      <div
        id="updateStatusModal"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden"
      >
        <div
          class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-custom-lg w-full max-w-md transform transition-all duration-300 fade-in"
        >
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold flex items-center">
              <div class="p-2 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 rounded-full mr-3">
                <i class="fas fa-user-edit"></i>
              </div>
              Cập nhật tình trạng học sinh
            </h3>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" id="cancelUpdateStatusBtnX">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg mb-6 border border-gray-200 dark:border-gray-600">
            <p class="flex items-center mb-2">
              <i class="fas fa-user text-primary-500 mr-2"></i>
              <strong>Học sinh:</strong> <span id="statusStudentName" class="ml-2">-</span>
            </p>
            <p class="flex items-center">
              <i class="fas fa-info-circle text-primary-500 mr-2"></i>
              <strong>Tình trạng hiện tại:</strong>
              <span id="statusCurrentStatus" class="ml-2 font-medium px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-600">-</span>
            </p>
          </div>
          <div class="mb-6">
            <label for="newStudentStatus" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">
              Tình trạng mới
            </label>
            <select
              id="newStudentStatus"
              class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base appearance-none bg-no-repeat"
              style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path fill=\"none\" d=\"M0 0h24v24H0z\"/><path d=\"M12 15l-4.243-4.243 1.415-1.414L12 12.172l2.828-2.829 1.415 1.414z\"/></svg>'); background-position: right 1rem center; padding-right: 2.5rem;"
            >
              <option value="đang học">Đang học</option>
              <option value="tạm nghỉ">Tạm nghỉ</option>
              <option value="đã nghỉ học">Đã nghỉ học</option>
            </select>
          </div>
          <div class="flex justify-end gap-3">
            <button
              type="button"
              id="cancelUpdateStatusBtn"
              class="py-3 px-5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
            >
              Hủy
            </button>
            <button
              type="button"
              id="confirmUpdateStatusBtn"
              class="py-3 px-5 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white rounded-lg transition-colors shadow-sm"
            >
              <i class="fas fa-check mr-2"></i> Cập nhật
            </button>
          </div>
        </div>
      </div>

      <!-- Collect Fee Modal -->
      <div
        id="collectFeeModal"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden"
      >
        <div
          class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-custom-lg w-full max-w-lg max-h-[90vh] overflow-y-auto transform transition-all duration-300 fade-in"
        >
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold flex items-center">
              <div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-full mr-3">
                <i class="fas fa-money-bill-wave"></i>
              </div>
              Thông tin thu học phí
            </h3>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" id="cancelFeeBtnX">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="p-5 bg-gray-50 dark:bg-gray-700/50 rounded-xl mb-6 border border-gray-200 dark:border-gray-600">
            <div class="flex items-start mb-2">
              <i class="fas fa-user-graduate mt-1 text-primary-500 mr-3"></i>
              <div>
                <p class="font-medium text-gray-800 dark:text-gray-200"><span id="feeStudentName">-</span></p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Khối: <span id="feeStudentGrade" class="font-medium">-</span></p>
                <p class="text-sm text-gray-600 dark:text-gray-400">SĐT: <span id="feeStudentPhone" class="font-medium">-</span></p>
              </div>
            </div>
          </div>
          <div class="mb-6">
            <h4 class="font-semibold mb-3 flex items-center">
              <i class="fas fa-list-alt text-primary-500 mr-2"></i>
              Chọn lớp học cần đóng phí:
            </h4>
            <div id="feeClassesList" class="space-y-3 max-h-60 overflow-y-auto p-1"></div>
          </div>
          <div class="mb-6 py-4 border-t border-b border-gray-200 dark:border-gray-700">
            <p class="font-bold flex justify-between items-center">
              <span class="text-gray-800 dark:text-gray-200">Tổng cộng:</span> 
              <span id="feeTotalAmount" class="text-xl text-primary-600 dark:text-primary-400">0 VNĐ</span>
            </p>
          </div>
          <div class="flex justify-end gap-3">
            <button
              type="button"
              id="cancelFeeBtn"
              class="py-3 px-5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
            >
              Hủy
            </button>
            <button
              type="button"
              id="confirmFeeBtn"
              class="py-3 px-5 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-lg transition-colors shadow-sm"
            >
              <i class="fas fa-money-bill-wave mr-2"></i> Xác nhận thu phí
            </button>
          </div>
        </div>
      </div>

      <!-- Receipt Modal -->
      <div
        id="receiptModal"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden"
      >
        <div
          class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-custom-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all duration-300 fade-in"
        >
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold flex items-center">
              <div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-full mr-3">
                <i class="fas fa-receipt"></i>
              </div>
              Biên lai thu học phí
            </h3>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" id="closeReceiptBtnX">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div id="receiptContent" class="mb-6 bg-white p-8 border border-gray-200 rounded-lg shadow-sm">
            <div class="text-center mb-8">
              <h1 class="text-2xl font-bold uppercase text-primary-600">BIÊN LAI THU HỌC PHÍ</h1>
              <div class="w-16 h-1 bg-primary-500 mx-auto mt-2"></div>
            </div>
            <div class="mb-6 flex justify-between flex-wrap gap-4">
              <p class="flex items-center text-gray-700">
                <i class="fas fa-receipt text-primary-500 mr-2"></i>
                <strong>Mã biên lai:</strong> <span id="receiptId" class="ml-2 font-medium">-</span>
              </p>
              <p class="flex items-center text-gray-700">
                <i class="fas fa-calendar-alt text-primary-500 mr-2"></i>
                <strong>Ngày:</strong> <span id="receiptDate" class="ml-2 font-medium">-</span>
              </p>
            </div>
            <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-100">
              <p class="flex items-center mb-2 text-gray-700">
                <i class="fas fa-user-graduate text-primary-500 mr-2"></i>
                <strong>Học sinh:</strong>
                <span id="receiptStudentName" class="ml-2 font-medium">-</span>
              </p>
              <p class="flex items-center mb-2 text-gray-700">
                <i class="fas fa-graduation-cap text-primary-500 mr-2"></i>
                <strong>Khối lớp:</strong>
                <span id="receiptStudentGrade" class="ml-2 font-medium">-</span>
              </p>
              <p class="flex items-center text-gray-700">
                <i class="fas fa-phone text-primary-500 mr-2"></i>
                <strong>Số điện thoại:</strong>
                <span id="receiptStudentPhone" class="ml-2 font-medium">-</span>
              </p>
            </div>
            <div class="mb-8">
              <h4 class="font-bold mb-3 flex items-center text-gray-800">
                <i class="fas fa-list-alt text-primary-500 mr-2"></i>
                Chi tiết học phí:
              </h4>
              <table class="w-full border-collapse border border-gray-300 rounded-lg overflow-hidden">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="border border-gray-300 p-3 text-left text-gray-700">
                      Lớp học
                    </th>
                    <th class="border border-gray-300 p-3 text-left text-gray-700">
                      Giáo viên
                    </th>
                    <th class="border border-gray-300 p-3 text-right text-gray-700">
                      Học phí
                    </th>
                  </tr>
                </thead>
                <tbody id="receiptDetailsList"></tbody>
                <tfoot>
                  <tr class="font-bold bg-gray-50">
                    <td
                      colspan="2"
                      class="border border-gray-300 p-3 text-right text-gray-700"
                    >
                      Tổng cộng:
                    </td>
                    <td
                      id="receiptTotal"
                      class="border border-gray-300 p-3 text-right text-primary-600 font-bold"
                    >
                      -
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="mt-10 flex justify-between">
              <div class="text-center w-5/12">
                <p class="font-medium text-gray-700">Người nộp tiền</p>
                <p class="italic text-gray-500">(Ký, ghi rõ họ tên)</p>
                <div class="h-20 border-b border-dashed border-gray-300 mt-10"></div>
              </div>
              <div class="text-center w-5/12">
                <p class="font-medium text-gray-700">Người thu tiền</p>
                <p class="italic text-gray-500">(Ký, ghi rõ họ tên)</p>
                <div class="h-20 border-b border-dashed border-gray-300 mt-10"></div>
              </div>
            </div>
          </div>
          <div class="flex justify-center gap-4">
            <button
              type="button"
              id="printReceiptBtn"
              class="py-3 px-5 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white rounded-lg transition-colors shadow-sm flex items-center"
            >
              <i class="fas fa-print mr-2"></i> In biên lai
            </button>
            <button
              type="button"
              id="closeReceiptBtn"
              class="py-3 px-5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>

      <!-- Student List Print Modal -->
      <div
        id="studentListPrintModal"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden"
      >
        <div
          class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-custom-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all duration-300 fade-in"
        >
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold flex items-center">
              <div class="p-2 bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full mr-3">
                <i class="fas fa-users"></i>
              </div>
              Danh sách học sinh
            </h3>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" id="closeStudentListBtnX">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div id="studentListContent" class="mb-6 bg-white p-8 border border-gray-200 rounded-lg shadow-sm">
            <div class="text-center mb-8">
              <h1 class="text-2xl font-bold uppercase text-primary-600">DANH SÁCH HỌC SINH</h1>
              <div class="w-16 h-1 bg-primary-500 mx-auto mt-2 mb-4"></div>
              <p class="text-lg mt-4 font-medium">
                Lớp: <span id="printClassName" class="text-primary-600">-</span>
              </p>
              <p class="flex items-center justify-center text-gray-700">
                <i class="fas fa-chalkboard-teacher text-primary-500 mr-2"></i>
                Giáo viên: <span id="printClassTeacher" class="ml-1 font-medium">-</span>
              </p>
              <p class="flex items-center justify-center text-gray-700">
                <i class="fas fa-calendar-alt text-primary-500 mr-2"></i>
                Lịch học: <span id="printClassSchedule" class="ml-1 font-medium">-</span>
              </p>
            </div>
            <div class="mb-8">
              <table class="w-full border-collapse border border-gray-300 rounded-lg overflow-hidden">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="border border-gray-300 p-3 text-center text-gray-700">STT</th>
                    <th class="border border-gray-300 p-3 text-left text-gray-700">
                      Họ và tên
                    </th>
                    <th class="border border-gray-300 p-3 text-left text-gray-700">Khối</th>
                    <th class="border border-gray-300 p-3 text-left text-gray-700">
                      Số điện thoại
                    </th>
                    <th class="border border-gray-300 p-3 text-center text-gray-700">
                      Tình trạng
                    </th>
                    <th class="border border-gray-300 p-3 text-center text-gray-700">
                      Trạng thái học phí
                    </th>
                  </tr>
                </thead>
                <tbody id="printStudentList"></tbody>
                <tfoot>
                  <tr class="bg-gray-50">
                    <td
                      colspan="6"
                      class="border border-gray-300 p-3 text-right font-medium text-gray-700"
                    >
                      <strong>Tổng số học sinh:</strong>
                      <span id="printTotalStudents" class="ml-2 text-primary-600 font-bold">0</span>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="mt-10 flex justify-end">
              <div class="text-center w-5/12">
                <p>Ngày _____ tháng _____ năm _____</p>
                <p class="font-medium mt-4 text-gray-700">Người lập danh sách</p>
                <p class="italic text-gray-500">(Ký, ghi rõ họ tên)</p>
                <div class="h-24 border-b border-dashed border-gray-300 mt-10"></div>
              </div>
            </div>
          </div>
          <div class="flex justify-center gap-4">
            <button
              type="button"
              id="printStudentListBtn"
              class="py-3 px-5 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white rounded-lg transition-colors shadow-sm flex items-center"
            >
              <i class="fas fa-print mr-2"></i> In danh sách
            </button>
            <button
              type="button"
              id="closeStudentListBtn"
              class="py-3 px-5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>

      <!-- Excel Export Instructions Modal -->
      <div
        id="excelInstructionsModal"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden"
      >
        <div
          class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-custom-lg w-full max-w-md transform transition-all duration-300 fade-in"
        >
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold flex items-center">
              <div class="p-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full mr-3">
                <i class="fas fa-file-excel"></i>
              </div>
              Tải xuống file Excel
            </h3>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" id="closeExcelInstructionsBtnX">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="mb-6">
            <div class="flex items-center justify-center mb-5">
              <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center text-blue-500 dark:text-blue-400">
                <i class="fas fa-check-circle text-3xl"></i>
              </div>
            </div>
            <p class="mb-4 text-gray-700 dark:text-gray-300 text-center">File Excel đã được tạo và sẽ mở trong tab mới.</p>
            <div class="p-4 border border-dashed rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50">
              <p class="mb-3 text-gray-700 dark:text-gray-300 font-medium">Để lưu file, vui lòng:</p>
              <ol class="list-decimal pl-5 space-y-2">
                <li class="text-gray-600 dark:text-gray-400">Nhấn <span class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded">Ctrl+S</span> (hoặc <span class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded">⌘+S</span> trên Mac)</li>
                <li class="text-gray-600 dark:text-gray-400">Hoặc nhấp chuột phải vào trang và chọn <span class="font-medium text-gray-700 dark:text-gray-300">"Lưu dưới dạng..."</span></li>
                <li class="text-gray-600 dark:text-gray-400">Chọn vị trí lưu trữ và đặt tên file</li>
              </ol>
            </div>
          </div>
          <div class="flex justify-center">
            <button
              type="button"
              id="closeExcelInstructionsBtn"
              class="py-3 px-5 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white rounded-lg transition-colors shadow-sm"
            >
              Đã hiểu
            </button>
          </div>
        </div>
      </div>

      <!-- Delete Confirmation Modal -->
      <div
        id="deleteConfirmModal"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden"
      >
        <div
          class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-custom-lg w-full max-w-md transform transition-all duration-300 fade-in"
        >
          <div class="flex justify-between items-center mb-6">
            <h3 id="deleteModalTitle" class="text-xl font-bold flex items-center">
              <div class="p-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-full mr-3">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              Xác nhận xóa
            </h3>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" id="cancelDeleteBtnX">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <p id="deleteModalMessage" class="mb-6 text-gray-700 dark:text-gray-300">
            Bạn có chắc chắn muốn xóa? Thao tác này không thể hoàn tác.
          </p>
          <div
            id="deleteModalError"
            class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-400 rounded-lg hidden"
          >
            <p class="font-medium">Không thể xóa vì:</p>
            <p id="deleteModalErrorMessage" class="mt-1"></p>
          </div>
          <div class="flex justify-end gap-3">
            <button
              type="button"
              id="cancelDeleteBtn"
              class="py-3 px-5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
            >
              Hủy
            </button>
            <button
              type="button"
              id="confirmDeleteBtn"
              class="py-3 px-5 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-lg transition-colors shadow-sm"
            >
              <i class="fas fa-trash-alt mr-2"></i> Xóa
            </button>
          </div>
        </div>
      </div>

      <!-- Income/Expense Modal -->
      <div
        id="incomeExpenseModal"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden"
      >
        <div
          class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-custom-lg w-full max-w-md transform transition-all duration-300 fade-in"
        >
          <div class="flex justify-between items-center mb-6">
            <h3 id="incomeExpenseModalTitle" class="text-xl font-bold flex items-center">
              <div class="p-2 bg-teal-100 dark:bg-teal-900/30 text-teal-600 dark:text-teal-400 rounded-full mr-3">
                <i class="fas fa-file-invoice-dollar"></i>
              </div>
              Thêm khoản thu chi
            </h3>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" id="cancelIncomeExpenseBtnX">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <form id="incomeExpenseForm" class="space-y-5">
            <input type="hidden" id="incomeExpenseId" />
            <div>
              <label for="incomeExpenseDate" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">
                Ngày <span class="text-red-500">*</span>
              </label>
              <input
                type="date"
                id="incomeExpenseDate"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                required
              />
            </div>
            <div>
              <label for="incomeExpenseType" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">
                Loại <span class="text-red-500">*</span>
              </label>
              <select
                id="incomeExpenseType"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base appearance-none bg-no-repeat"
                style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path fill=\"none\" d=\"M0 0h24v24H0z\"/><path d=\"M12 15l-4.243-4.243 1.415-1.414L12 12.172l2.828-2.829 1.415 1.414z\"/></svg>'); background-position: right 1rem center; padding-right: 2.5rem;"
                required
              >
                <option value="">-- Chọn loại --</option>
                <option value="thu">Khoản thu</option>
                <option value="chi">Khoản chi</option>
              </select>
            </div>
            <div>
              <label for="incomeExpenseDesc" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">
                Mô tả <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="incomeExpenseDesc"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                placeholder="Ví dụ: Tiền mua sách, Tiền thuê phòng..."
                required
              />
            </div>
            <div>
              <label for="incomeExpenseAmount" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">
                Số tiền (VNĐ) <span class="text-red-500">*</span>
              </label>
              <input
                type="number"
                id="incomeExpenseAmount"
                class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base"
                required
              />
            </div>
            <div class="flex justify-end gap-3 pt-2">
              <button
                type="button"
                id="cancelIncomeExpenseBtn"
                class="py-3 px-5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
              >
                Hủy
              </button>
              <button
                type="submit"
                class="py-3 px-5 bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 text-white rounded-lg transition-colors shadow-sm"
              >
                <i class="fas fa-save mr-2"></i> Lưu lại
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Firebase Configuration and Initialization
      const firebaseConfig = {
        apiKey: "AIzaSyBwM2VW3sAXoBtUmQBFeHuB66bw9o1de90",
        authDomain: "ductri-9a8df.firebaseapp.com",
        projectId: "ductri-9a8df",
        storageBucket: "ductri-9a8df.firebasestorage.app",
        messagingSenderId: "735484125855",
        appId: "1:735484125855:web:78dde7e0d3521ae6a7b8aa",
        measurementId: "G-Q93RY2418L",
        databaseURL: "https://ductri-9a8df-default-rtdb.asia-southeast1.firebasedatabase.app"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      
      // Get Firestore instance
      const db = firebase.firestore();
      // Get Authentication instance
      const auth = firebase.auth();

      // Auth Manager using Firebase Authentication
      const AuthManager = {
        securityCode: "Ductrienglishcenter8386@",

        init() {
          this.setupEventListeners();
            this.checkAuth();
        },

        setupEventListeners() {
          // Login form
          document.getElementById("loginBtn").addEventListener("click", () => this.login());
          document.getElementById("loginPassword").addEventListener("keydown", (e) => {
            if (e.key === "Enter") this.login();
          });
          
          // Registration form
          document.getElementById("registerBtn").addEventListener("click", () => this.register());
          document.getElementById("securityCode").addEventListener("keydown", (e) => {
            if (e.key === "Enter") this.register();
          });
          
          // Switch between login and register forms
          document.getElementById("showRegisterBtn").addEventListener("click", (e) => {
            e.preventDefault();
            this.showRegisterForm();
          });
          document.getElementById("showLoginBtn").addEventListener("click", (e) => {
            e.preventDefault();
            this.showLoginForm();
          });

          // Logout button
          document.getElementById("logoutBtn").addEventListener("click", () => this.logout());
          
          // Modal close X buttons
          document.getElementById("cancelClassBtnX").addEventListener("click", () => {
            document.getElementById("classModal").classList.add("hidden");
          });
          document.getElementById("cancelStudentBtnX").addEventListener("click", () => {
            document.getElementById("studentModal").classList.add("hidden");
          });
          document.getElementById("cancelImportBtnX").addEventListener("click", () => {
            document.getElementById("importStudentsModal").classList.add("hidden");
          });
          document.getElementById("cancelAddStudentToClassBtnX").addEventListener("click", () => {
            document.getElementById("addStudentToClassModal").classList.add("hidden");
          });
          document.getElementById("cancelUpdateStatusBtnX").addEventListener("click", () => {
            document.getElementById("updateStatusModal").classList.add("hidden");
          });
          document.getElementById("cancelFeeBtnX").addEventListener("click", () => {
            document.getElementById("collectFeeModal").classList.add("hidden");
          });
          document.getElementById("closeReceiptBtnX").addEventListener("click", () => {
            document.getElementById("receiptModal").classList.add("hidden");
          });
          document.getElementById("closeStudentListBtnX").addEventListener("click", () => {
            document.getElementById("studentListPrintModal").classList.add("hidden");
          });
          document.getElementById("closeExcelInstructionsBtnX").addEventListener("click", () => {
            document.getElementById("excelInstructionsModal").classList.add("hidden");
          });
          document.getElementById("cancelDeleteBtnX").addEventListener("click", () => {
            document.getElementById("deleteConfirmModal").classList.add("hidden");
          });
          document.getElementById("cancelIncomeExpenseBtnX").addEventListener("click", () => {
            document.getElementById("incomeExpenseModal").classList.add("hidden");
          });
        },

        showLoginForm() {
          document.getElementById("registerForm").classList.add("hidden");
          document.getElementById("loginForm").classList.remove("hidden");
          
          // Add fade-in class for animation
          document.getElementById("loginForm").classList.add("fade-in");
          
          document.getElementById("loginError").classList.add("hidden");
          document.getElementById("loginUsername").focus();
        },

        showRegisterForm() {
          document.getElementById("loginForm").classList.add("hidden");
          document.getElementById("registerForm").classList.remove("hidden");
          
          // Add fade-in class for animation
          document.getElementById("registerForm").classList.add("fade-in");
          
          document.getElementById("registerError").classList.add("hidden");
          document.getElementById("registerUsername").focus();
        },

        login() {
          const username = document.getElementById("loginUsername").value.trim();
          const password = document.getElementById("loginPassword").value;
          const errorElement = document.getElementById("loginError");

          if (!username || !password) {
            errorElement.innerHTML = '<div class="flex"><div class="flex-shrink-0"><i class="fas fa-exclamation-circle"></i></div><div class="ml-3">Vui lòng nhập tên đăng nhập và mật khẩu</div></div>';
            errorElement.classList.remove("hidden");
            return;
          }

          // Show loading animation
          const loginBtn = document.getElementById("loginBtn");
          const originalContent = loginBtn.innerHTML;
          loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang đăng nhập...';
          loginBtn.disabled = true;

          // Firebase authentication with email (username + domain)
          const email = `${username}@ductri.com`;
          
          auth.signInWithEmailAndPassword(email, password)
            .then(userCredential => {
              // Successful login
              this.showApp();
              showToast(`Chào mừng, ${username}!`, "success");
            })
            .catch(error => {
              // Handle login errors
              console.error("Login error:", error);
              let errorMessage;
              
              switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                  errorMessage = 'Tên đăng nhập hoặc mật khẩu không đúng';
                  break;
                case 'auth/too-many-requests':
                  errorMessage = 'Quá nhiều lần đăng nhập không thành công. Vui lòng thử lại sau.';
                  break;
                default:
                  errorMessage = 'Đăng nhập thất bại. Vui lòng thử lại.';
              }
              
              errorElement.innerHTML = `<div class="flex"><div class="flex-shrink-0"><i class="fas fa-exclamation-circle"></i></div><div class="ml-3">${errorMessage}</div></div>`;
            errorElement.classList.remove("hidden");
            })
            .finally(() => {
            // Reset button state
            loginBtn.innerHTML = originalContent;
            loginBtn.disabled = false;
            });
        },

        register() {
          const username = document.getElementById("registerUsername").value.trim();
          const password = document.getElementById("registerPassword").value;
          const securityCode = document.getElementById("securityCode").value;
          const errorElement = document.getElementById("registerError");

          if (!username || !password) {
            errorElement.innerHTML = '<div class="flex"><div class="flex-shrink-0"><i class="fas fa-exclamation-circle"></i></div><div class="ml-3">Vui lòng nhập tên đăng nhập và mật khẩu</div></div>';
            errorElement.classList.remove("hidden");
            return;
          }

          if (securityCode !== this.securityCode) {
            errorElement.innerHTML = '<div class="flex"><div class="flex-shrink-0"><i class="fas fa-exclamation-circle"></i></div><div class="ml-3">Mã bảo vệ không đúng</div></div>';
            errorElement.classList.remove("hidden");
            return;
          }

          // Show loading animation
          const registerBtn = document.getElementById("registerBtn");
          const originalContent = registerBtn.innerHTML;
          registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang đăng ký...';
          registerBtn.disabled = true;

          // Register with Firebase using email (username + domain)
          const email = `${username}@ductri.com`;
          
          auth.createUserWithEmailAndPassword(email, password)
            .then(userCredential => {
              // Create user profile in Firestore
              const user = userCredential.user;
              return db.collection('users').doc(user.uid).set({
                username: username,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            })
            .then(() => {
              // Switch to login form and show success message
              this.showLoginForm();
              showToast("Đăng ký tài khoản thành công. Vui lòng đăng nhập.", "success");
            })
            .catch(error => {
              console.error("Registration error:", error);
              let errorMessage;
              
              switch (error.code) {
                case 'auth/email-already-in-use':
                  errorMessage = 'Tên đăng nhập đã tồn tại';
                  break;
                case 'auth/invalid-email':
                  errorMessage = 'Tên đăng nhập không hợp lệ';
                  break;
                case 'auth/weak-password':
                  errorMessage = 'Mật khẩu quá yếu. Vui lòng chọn mật khẩu mạnh hơn.';
                  break;
                default:
                  errorMessage = 'Đăng ký thất bại. Vui lòng thử lại.';
              }
              
              errorElement.innerHTML = `<div class="flex"><div class="flex-shrink-0"><i class="fas fa-exclamation-circle"></i></div><div class="ml-3">${errorMessage}</div></div>`;
            errorElement.classList.remove("hidden");
            })
            .finally(() => {
            // Reset button state
            registerBtn.innerHTML = originalContent;
            registerBtn.disabled = false;
            });
        },

        logout() {
          // Show logout animation
          const logoutBtn = document.getElementById("logoutBtn");
          const originalContent = logoutBtn.innerHTML;
          logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang đăng xuất...';
          logoutBtn.disabled = true;

          auth.signOut()
            .then(() => {
                // Show auth section and hide app
                document.getElementById("authSection").classList.remove("hidden");
                document.getElementById("appSection").classList.add("hidden");
                
                // Reset login form
                document.getElementById("loginForm").reset();
                document.getElementById("loginError").classList.add("hidden");
                
                showToast("Đã đăng xuất thành công", "info");
            })
            .catch(error => {
            console.error("Logout error:", error);
              showToast("Lỗi khi đăng xuất", "error");
            })
            .finally(() => {
            // Reset button state
            logoutBtn.innerHTML = originalContent;
            logoutBtn.disabled = false;
            });
        },

        checkAuth() {
          // Monitor auth state
          auth.onAuthStateChanged(user => {
            if (user) {
              this.showApp();
            } else {
              // User is signed out
              document.getElementById("authSection").classList.remove("hidden");
              document.getElementById("appSection").classList.add("hidden");
            }
          });
        },

        showApp() {
          document.getElementById("authSection").classList.add("hidden");
          document.getElementById("appSection").classList.remove("hidden");
        }
      };
      
      // Data Store using Firestore
      const DataStore = {
        classes: [],
        archivedClasses: [],
        students: [],
        transactions: [],
        incomeExpense: [],

        init() {
          this.setupRealtimeListeners();
          this.initializeMonthYearSelectors();
        },
        
        setupRealtimeListeners() {
          // Listen for classes
          db.collection('classes')
            .where('archived', '==', false)
            .onSnapshot(snapshot => {
              this.classes = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              UIController.renderClasses();
              UIController.refreshStudentClassSelect();
            
              // When classes change, we need to refresh any active class detail view
              const classDetailSection = document.getElementById('classDetailSection');
              if (!classDetailSection.classList.contains('hidden')) {
                const classId = classDetailSection.dataset.classId;
                if (classId) {
                  UIController.renderClassStudents(classId);
            }
              }
            }, error => {
              console.error("Error loading classes:", error);
              showToast("Lỗi khi tải dữ liệu lớp học", "error");
            });
            
          // Listen for archived classes
          db.collection('classes')
            .where('archived', '==', true)
            .onSnapshot(snapshot => {
              this.archivedClasses = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              UIController.renderArchivedClasses();
            }, error => {
              console.error("Error loading archived classes:", error);
            });
            
          // Listen for students
          db.collection('students')
            .onSnapshot(snapshot => {
              this.students = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              UIController.renderStudents();
              
              // If we're viewing class details, refresh the students list
              const classDetailSection = document.getElementById('classDetailSection');
              if (!classDetailSection.classList.contains('hidden')) {
                const classId = classDetailSection.dataset.classId;
                if (classId) {
                  UIController.renderClassStudents(classId);
                }
              }
            }, error => {
              console.error("Error loading students:", error);
              showToast("Lỗi khi tải dữ liệu học sinh", "error");
            });
            
          // Listen for transactions
          db.collection('transactions')
            .orderBy('date', 'desc')
            .limit(20) // Limit to recent transactions for performance
            .onSnapshot(snapshot => {
              this.transactions = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              UIController.renderTransactions();
              
              // Update reports if the report section is active
              if (!document.getElementById('reportSection').classList.contains('hidden')) {
                UIController.renderReports();
              }
            }, error => {
              console.error("Error loading transactions:", error);
              showToast("Lỗi khi tải dữ liệu giao dịch", "error");
            });
            
          // Listen for income/expense entries
          db.collection('incomeExpense')
            .orderBy('date', 'desc')
            .onSnapshot(snapshot => {
              this.incomeExpense = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              
              // Update reports if the report section is active
              if (!document.getElementById('reportSection').classList.contains('hidden')) {
                UIController.renderIncomeExpense();
                UIController.renderReports();
              }
            }, error => {
              console.error("Error loading income/expense data:", error);
              showToast("Lỗi khi tải dữ liệu thu chi", "error");
            });
        },
        
        initializeMonthYearSelectors() {
          const reportMonthSelect = document.getElementById('reportMonth');
          const reportYearSelect = document.getElementById('reportYear');
          
          // Clear existing options
          reportMonthSelect.innerHTML = '';
          reportYearSelect.innerHTML = '';
          
          // Add month options
          const months = [
            { value: '0', text: 'Tất cả các tháng' },
            { value: '1', text: 'Tháng 1' },
            { value: '2', text: 'Tháng 2' },
            { value: '3', text: 'Tháng 3' },
            { value: '4', text: 'Tháng 4' },
            { value: '5', text: 'Tháng 5' },
            { value: '6', text: 'Tháng 6' },
            { value: '7', text: 'Tháng 7' },
            { value: '8', text: 'Tháng 8' },
            { value: '9', text: 'Tháng 9' },
            { value: '10', text: 'Tháng 10' },
            { value: '11', text: 'Tháng 11' },
            { value: '12', text: 'Tháng 12' }
          ];
          
          months.forEach(month => {
            const option = document.createElement('option');
            option.value = month.value;
            option.textContent = month.text;
            reportMonthSelect.appendChild(option);
          });
          
          // Add year options (current year and 5 years back)
          const currentYear = new Date().getFullYear();
          const option = document.createElement('option');
          option.value = '0';
          option.textContent = 'Tất cả các năm';
          reportYearSelect.appendChild(option);
          
          for (let year = currentYear; year >= currentYear - 5; year--) {
            const option = document.createElement('option');
            option.value = year.toString();
            option.textContent = year.toString();
            reportYearSelect.appendChild(option);
          }
          
          // Set current month and year as default
          const currentMonth = new Date().getMonth() + 1; // JavaScript months are 0-based
          reportMonthSelect.value = currentMonth.toString();
          reportYearSelect.value = currentYear.toString();
          
          // Add event listener for the filter button
          document.getElementById('applyReportFilter').addEventListener('click', () => {
            UIController.renderReports();
            UIController.renderIncomeExpense();
          });
        },

        addClass(classData) {
          return db.collection('classes').add({
            name: classData.name,
            grade: classData.grade,
            teacher: classData.teacher,
            startDate: classData.startDate,
            schedule: classData.schedule || "",
            fee: parseInt(classData.fee) || 0,
            teacherFee: parseInt(classData.teacherFee) || 0,
            students: [],
            archived: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(docRef => {
            return docRef.id;
          })
          .catch(error => {
            console.error("Error adding class:", error);
            return null;
          });
        },

        archiveClass(classId) {
          return db.collection('classes').doc(classId).update({
            archived: true,
            archivedAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(() => true)
          .catch(error => {
            console.error("Error archiving class:", error);
            return false;
          });
        },

        restoreClass(classId) {
          return db.collection('classes').doc(classId).update({
            archived: false,
            archivedAt: null
          })
          .then(() => true)
          .catch(error => {
            console.error("Error restoring class:", error);
            return false;
          });
        },

        updateClass(classId, classData) {
          return db.collection('classes').doc(classId).update({
            name: classData.name,
            grade: classData.grade,
            teacher: classData.teacher,
            startDate: classData.startDate,
            schedule: classData.schedule || "",
            fee: parseInt(classData.fee) || 0,
            teacherFee: parseInt(classData.teacherFee) || 0,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(() => true)
          .catch(error => {
            console.error("Error updating class:", error);
            return false;
          });
        },

        deleteClass(classId) {
          // First check if the class has any students
          return db.collection('classes').doc(classId).get()
            .then(doc => {
              if (!doc.exists) {
                return { success: false, error: "Không tìm thấy lớp học" };
          }

              const classData = doc.data();
              const students = classData.students || [];
              
              if (students.length > 0) {
            return {
              success: false,
                  error: "Lớp học này có học sinh đang theo học. Vui lòng xóa học sinh khỏi lớp trước."
            };
          }

              // Check for transactions related to this class
              return db.collection('transactions')
                .where('classDetails', 'array-contains', { classId: classId })
                .limit(1)
                .get()
                .then(snapshot => {
                  if (!snapshot.empty) {
            return {
              success: false,
                      error: "Lớp học này có giao dịch học phí. Không thể xóa lớp học có giao dịch."
            };
          }

                  // Safe to delete the class
                  return db.collection('classes').doc(classId).delete()
                    .then(() => ({ success: true }))
                    .catch(error => {
                      console.error("Error deleting class:", error);
                      return { success: false, error: "Lỗi khi xóa lớp học" };
                    });
                });
            })
            .catch(error => {
              console.error("Error checking class:", error);
              return { success: false, error: "Lỗi khi kiểm tra lớp học" };
            });
        },

        deleteArchivedClass(classId) {
          // Use the same logic as deleteClass
          return this.deleteClass(classId);
        },

        addStudent(studentData) {
          // Create a new student document
          return db.collection('students').add({
            name: studentData.name,
            grade: studentData.grade,
            phone: studentData.phone || "",
            status: studentData.status || "đang học",
            classPaid: {},
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(docRef => {
            const studentId = docRef.id;

            // If class IDs are specified, add student to those classes
            const promises = [];
          if (studentData.classIds && studentData.classIds.length) {
              studentData.classIds.forEach(classId => {
                const promise = db.collection('classes').doc(classId).update({
                  students: firebase.firestore.FieldValue.arrayUnion(studentId)
                });
                promises.push(promise);
            });
          }

            return Promise.all(promises).then(() => studentId);
          })
          .catch(error => {
            console.error("Error adding student:", error);
            return null;
          });
        },

        updateStudent(studentId, studentData) {
          // Get current class assignments to determine which ones to update
          return db.collection('students').doc(studentId).get()
            .then(doc => {
              if (!doc.exists) {
                return false;
              }

          const oldClassIds = this.getStudentClassIds(studentId);
          const newClassIds = studentData.classIds || [];
              const promises = [];

          // Remove student from classes that are no longer selected
              oldClassIds.forEach(classId => {
            if (!newClassIds.includes(classId)) {
                  const promise = db.collection('classes').doc(classId).update({
                    students: firebase.firestore.FieldValue.arrayRemove(studentId)
                  });
                  promises.push(promise);
            }
          });

          // Add student to newly selected classes
              newClassIds.forEach(classId => {
            if (!oldClassIds.includes(classId)) {
                  const promise = db.collection('classes').doc(classId).update({
                    students: firebase.firestore.FieldValue.arrayUnion(studentId)
                  });
                  promises.push(promise);
            }
          });

              // Preserve the paid status
              const classPaid = doc.data().classPaid || {};
              
              // Update student document
              const updatePromise = db.collection('students').doc(studentId).update({
                name: studentData.name,
                grade: studentData.grade,
                phone: studentData.phone || "",
            status: studentData.status || "đang học",
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              promises.push(updatePromise);
              
              return Promise.all(promises).then(() => true);
            })
            .catch(error => {
              console.error("Error updating student:", error);
              return false;
            });
        },

        updateStudentStatus(studentId, newStatus) {
          return db.collection('students').doc(studentId).update({
            status: newStatus,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(() => true)
          .catch(error => {
            console.error("Error updating student status:", error);
            return false;
          });
        },

        deleteStudent(studentId) {
          // First get the student to check their status
          return db.collection('students').doc(studentId).get()
            .then(doc => {
              if (!doc.exists) {
                return { success: false, error: "Không tìm thấy học sinh" };
          }
              
              const student = doc.data();
          
          // Allow deleting students who have stopped studying
          if (student.status === "đã nghỉ học") {
                // Remove student from all classes
                const batch = db.batch();
                
                // First, find all classes that contain this student
                return db.collection('classes')
                  .where('students', 'array-contains', studentId)
                  .get()
                  .then(snapshot => {
                    // For each class, remove the student
                    snapshot.forEach(classDoc => {
                      const classRef = db.collection('classes').doc(classDoc.id);
                      batch.update(classRef, {
                        students: firebase.firestore.FieldValue.arrayRemove(studentId)
                      });
                    });
                    
                    // Delete the student document
                    const studentRef = db.collection('students').doc(studentId);
                    batch.delete(studentRef);
                    
                    // Commit the batch
                    return batch.commit()
                      .then(() => ({ success: true }))
                      .catch(error => {
                        console.error("Error in batch delete:", error);
                        return { success: false, error: "Lỗi khi xóa học sinh" };
                      });
                  });
          }
          
          // For actively studying or temporarily paused students, check if they have paid tuition
          if (student.classPaid) {
                const hasPaidClasses = Object.values(student.classPaid).some(paid => paid);
            if (hasPaidClasses) {
              return {
                success: false,
                    error: "Học sinh này đã đóng học phí. Chỉ học sinh có trạng thái \"Đã nghỉ học\" mới có thể xóa sau khi đóng học phí."
              };
            }
          }

          // If the student is still active but hasn't paid, allow deletion
              // Remove from all classes and delete student
              const batch = db.batch();
              
              return db.collection('classes')
                .where('students', 'array-contains', studentId)
                .get()
                .then(snapshot => {
                  snapshot.forEach(classDoc => {
                    const classRef = db.collection('classes').doc(classDoc.id);
                    batch.update(classRef, {
                      students: firebase.firestore.FieldValue.arrayRemove(studentId)
                    });
          });

                  const studentRef = db.collection('students').doc(studentId);
                  batch.delete(studentRef);
                  
                  return batch.commit()
                    .then(() => ({ success: true }))
                    .catch(error => {
                      console.error("Error in batch delete:", error);
                      return { success: false, error: "Lỗi khi xóa học sinh" };
                    });
                });
            })
            .catch(error => {
              console.error("Error checking student:", error);
              return { success: false, error: "Lỗi khi kiểm tra học sinh" };
            });
        },

        addStudentToClass(studentId, classId) {
          return db.collection('classes').doc(classId).update({
            students: firebase.firestore.FieldValue.arrayUnion(studentId)
          })
          .then(() => true)
          .catch(error => {
            console.error("Error adding student to class:", error);
            return false;
          });
        },

        removeStudentFromClass(studentId, classId) {
          // First check if student has paid for this class
          return db.collection('students').doc(studentId).get()
            .then(doc => {
              if (!doc.exists) {
                return { success: false, error: "Không tìm thấy học sinh" };
              }
              
              const student = doc.data();
              if (student.classPaid && student.classPaid[classId] && student.status !== "đã nghỉ học") {
            return {
              success: false,
                  error: "Học sinh này đã đóng học phí. Chỉ có thể xóa khỏi lớp khi học sinh đã nghỉ học."
            };
          }

              // Safe to remove student from class
              return db.collection('classes').doc(classId).update({
                students: firebase.firestore.FieldValue.arrayRemove(studentId)
              })
              .then(() => ({ success: true }))
              .catch(error => {
                console.error("Error removing student from class:", error);
                return { success: false, error: "Lỗi khi xóa học sinh khỏi lớp" };
              });
            })
            .catch(error => {
              console.error("Error checking student payment status:", error);
              return { success: false, error: "Lỗi khi kiểm tra trạng thái học phí" };
            });
        },

        getStudentClassIds(studentId) {
          // Return class IDs for the student from loaded data
          const classIds = [];
          this.classes.forEach(classObj => {
            if (classObj.students && classObj.students.includes(studentId)) {
              classIds.push(classObj.id);
            }
          });
          return classIds;
        },

        getStudentClasses(studentId) {
          // Return class objects for the student from loaded data
          return this.classes.filter(
            classObj => classObj.students && classObj.students.includes(studentId)
          );
        },

        getUnpaidClasses(studentId) {
          const student = this.students.find(s => s.id === studentId);
          if (!student) return [];

          return this.getStudentClasses(studentId).filter(classObj => {
            return !student.classPaid || !student.classPaid[classObj.id];
          });
        },

        recordPayment(studentId, classIds, amount) {
          const student = this.students.find(s => s.id === studentId);
          if (!student) return false;

          // Create a batch to update multiple documents atomically
          const batch = db.batch();

          // Prepare payment details
          const classDetails = [];
          let totalAmount = 0;

          // Get class information for the transaction
          classIds.forEach(classId => {
            const classObj = this.classes.find(c => c.id === classId);
            if (classObj) {
              totalAmount += parseInt(classObj.fee || 0);

              classDetails.push({
                classId,
                className: classObj.name,
                teacherName: classObj.teacher,
                fee: classObj.fee,
              });
            }
          });

          // Create transaction record
          const transactionId = `TR${Date.now()}`;
          const transactionRef = db.collection('transactions').doc(transactionId);
          
          batch.set(transactionRef, {
            id: transactionId,
            date: new Date().toISOString(),
            studentId,
            studentName: student.name,
            classDetails,
            amount: totalAmount,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          // Update student's paid classes
          const studentRef = db.collection('students').doc(studentId);
          
          // We need to get the current classPaid object first
          return studentRef.get()
            .then(doc => {
              if (!doc.exists) {
                throw new Error("Student not found");
              }
              
              const studentData = doc.data();
              const classPaid = studentData.classPaid || {};
              
              // Mark classes as paid
              classIds.forEach(classId => {
                classPaid[classId] = true;
              });
              
              // Update the student document
              batch.update(studentRef, { 
                classPaid: classPaid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              
              // Commit the batch
              return batch.commit()
                .then(() => {
                  // Return transaction details for receipt
                  return {
                    id: transactionId,
                    date: new Date().toISOString(),
                    studentId,
                    studentName: student.name,
                    classDetails,
                    amount: totalAmount
                  };
                });
            })
            .catch(error => {
              console.error("Error recording payment:", error);
              return null;
            });
        },

        addIncomeExpense(data) {
          return db.collection('incomeExpense').add({
            date: data.date,
            type: data.type,
            description: data.description,
            amount: parseInt(data.amount) || 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(docRef => {
            return docRef.id;
          })
          .catch(error => {
            console.error("Error adding income/expense:", error);
            return null;
          });
        },
        
        updateIncomeExpense(id, data) {
          return db.collection('incomeExpense').doc(id).update({
            date: data.date,
            type: data.type,
            description: data.description,
            amount: parseInt(data.amount) || 0,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(() => true)
          .catch(error => {
            console.error("Error updating income/expense:", error);
            return false;
          });
        },
        
        deleteIncomeExpense(id) {
          return db.collection('incomeExpense').doc(id).delete()
            .then(() => ({ success: true }))
            .catch(error => {
              console.error("Error deleting income/expense:", error);
              return { success: false, error: "Lỗi khi xóa khoản thu chi" };
            });
        },

        getFinancialSummary() {
          // Get the selected month and year from the filters
          const monthFilter = parseInt(document.getElementById('reportMonth').value);
          const yearFilter = parseInt(document.getElementById('reportYear').value);
          
          let totalIncome = 0;
          let totalTeacherPayment = 0;
          let additionalIncome = 0;
          let additionalExpenses = 0;

          // Filter transactions by month/year if selected
          let filteredTransactions = this.transactions;
          if (monthFilter > 0 || yearFilter > 0) {
            filteredTransactions = this.transactions.filter(transaction => {
              const transactionDate = new Date(transaction.date);
              const transactionMonth = transactionDate.getMonth() + 1; // JavaScript months are 0-based
              const transactionYear = transactionDate.getFullYear();
              
              // Apply filters
              if (monthFilter > 0 && yearFilter > 0) {
                return transactionMonth === monthFilter && transactionYear === yearFilter;
              } else if (monthFilter > 0) {
                return transactionMonth === monthFilter;
              } else if (yearFilter > 0) {
                return transactionYear === yearFilter;
              }
              return true;
            });
          }
          
          // Calculate total income from transactions
          filteredTransactions.forEach(transaction => {
            totalIncome += transaction.amount;
          });

          // Filter income/expense entries by month/year if selected
          let filteredEntries = this.incomeExpense;
          if (monthFilter > 0 || yearFilter > 0) {
            filteredEntries = this.incomeExpense.filter(entry => {
              const entryDate = new Date(entry.date);
              const entryMonth = entryDate.getMonth() + 1; // JavaScript months are 0-based
              const entryYear = entryDate.getFullYear();
              
              // Apply filters
              if (monthFilter > 0 && yearFilter > 0) {
                return entryMonth === monthFilter && entryYear === yearFilter;
              } else if (monthFilter > 0) {
                return entryMonth === monthFilter;
              } else if (yearFilter > 0) {
                return entryYear === yearFilter;
              }
              return true;
            });
          }
          
          // Calculate additional income and expenses
          filteredEntries.forEach(entry => {
            if (entry.type === 'thu') {
              additionalIncome += parseInt(entry.amount) || 0;
            } else if (entry.type === 'chi') {
              additionalExpenses += parseInt(entry.amount) || 0;
            }
          });

          // Calculate teacher payments based on active classes
          this.classes.forEach(classObj => {
            if (classObj.students && classObj.students.length > 0) {
              // For each student in the class
              classObj.students.forEach(studentId => {
                const student = this.students.find(s => s.id === studentId);
                // If the student has paid for this class
                if (student && student.classPaid && student.classPaid[classObj.id]) {
                  // Check if we need to filter by month/year
                  if (monthFilter > 0 || yearFilter > 0) {
                    // Find the transaction for this student and class
                    const matchingTransaction = filteredTransactions.find(t => 
                      t.studentId === studentId && 
                      t.classDetails.some(cd => cd.classId === classObj.id)
                    );
                    
                    // Only count teacher payment if there's a matching transaction in the filtered period
                    if (matchingTransaction && classObj.teacherFee) {
                      totalTeacherPayment += parseInt(classObj.teacherFee);
                    }
                  } else {
                    // No time filter, count all teacher payments
                    if (classObj.teacherFee) {
                      totalTeacherPayment += parseInt(classObj.teacherFee);
                    }
                  }
                }
              });
            }
          });

          return {
            totalIncome,
            additionalIncome,
            totalTeacherPayment,
            additionalExpenses,
            totalExpenses: totalTeacherPayment + additionalExpenses,
            profit: (totalIncome + additionalIncome) - (totalTeacherPayment + additionalExpenses),
          };
        },

        getClassPerformance() {
          // Get the selected month and year from the filters
          const monthFilter = parseInt(document.getElementById('reportMonth').value);
          const yearFilter = parseInt(document.getElementById('reportYear').value);
          
          // Filter transactions by month/year if selected
          let filteredTransactions = this.transactions;
          if (monthFilter > 0 || yearFilter > 0) {
            filteredTransactions = this.transactions.filter(transaction => {
              const transactionDate = new Date(transaction.date);
              const transactionMonth = transactionDate.getMonth() + 1; // JavaScript months are 0-based
              const transactionYear = transactionDate.getFullYear();
              
              // Apply filters
              if (monthFilter > 0 && yearFilter > 0) {
                return transactionMonth === monthFilter && transactionYear === yearFilter;
              } else if (monthFilter > 0) {
                return transactionMonth === monthFilter;
              } else if (yearFilter > 0) {
                return transactionYear === yearFilter;
              }
              return true;
            });
          }
          
          return this.classes.map(classObj => {
            const totalStudents = classObj.students ? classObj.students.length : 0;
            
            // If filtering by time period, we need to count students who paid in that period
            let paidStudents = 0;
            let income = 0;
            let teacherCost = 0;
            
            if (monthFilter > 0 || yearFilter > 0) {
              // Extract unique student IDs who paid for this class in the filtered period
              const paidStudentIds = new Set();
              
              filteredTransactions.forEach(transaction => {
                // Check if this transaction includes this class
                const includesThisClass = transaction.classDetails.some(
                  cd => cd.classId === classObj.id
                );
                
                if (includesThisClass) {
                  paidStudentIds.add(transaction.studentId);
                  // Find the class detail to get the fee
                  const classDetail = transaction.classDetails.find(
                    cd => cd.classId === classObj.id
                  );
                  if (classDetail) {
                    income += parseInt(classDetail.fee || 0);
                  }
                }
              });
              
              paidStudents = paidStudentIds.size;
              teacherCost = paidStudents * parseInt(classObj.teacherFee || 0);
            } else {
              // No time filter, count all paid students
            if (classObj.students && classObj.students.length > 0) {
              classObj.students.forEach(studentId => {
                const student = this.students.find(s => s.id === studentId);
                if (student && student.classPaid && student.classPaid[classObj.id]) {
                  paidStudents++;
                }
              });
            }

              income = paidStudents * parseInt(classObj.fee || 0);
              teacherCost = paidStudents * parseInt(classObj.teacherFee || 0);
            }

            return {
              id: classObj.id,
              name: classObj.name,
              teacher: classObj.teacher,
              totalStudents,
              paidStudents,
              income,
              teacherCost,
              profit: income - teacherCost,
            };
          });
        },

        getFeeStatus() {
          // Get the selected month and year from the filters
          const monthFilter = parseInt(document.getElementById('reportMonth').value);
          const yearFilter = parseInt(document.getElementById('reportYear').value);
          
          // Filter transactions by month/year if selected
          let filteredTransactions = this.transactions;
          if (monthFilter > 0 || yearFilter > 0) {
            filteredTransactions = this.transactions.filter(transaction => {
              const transactionDate = new Date(transaction.date);
              const transactionMonth = transactionDate.getMonth() + 1; // JavaScript months are 0-based
              const transactionYear = transactionDate.getFullYear();
              
              // Apply filters
              if (monthFilter > 0 && yearFilter > 0) {
                return transactionMonth === monthFilter && transactionYear === yearFilter;
              } else if (monthFilter > 0) {
                return transactionMonth === monthFilter;
              } else if (yearFilter > 0) {
                return transactionYear === yearFilter;
              }
              return true;
            });
          }
          
          const result = [];

          // When filtering by period, we only show fees from that period
          if (monthFilter > 0 || yearFilter > 0) {
            filteredTransactions.forEach(transaction => {
              const student = this.students.find(s => s.id === transaction.studentId);
              if (!student) return;
              
              transaction.classDetails.forEach(classDetail => {
                const classObj = this.classes.find(c => c.id === classDetail.classId);
                if (!classObj) return;
                
                result.push({
                  className: classObj.name,
                  studentName: student.name,
                  status: "Đã đóng",
                  paymentDate: new Date(transaction.date).toLocaleDateString("vi-VN"),
                  amount: formatCurrency(parseInt(classDetail.fee || 0)),
                });
              });
            });
          } else {
            // No time filter, show all fee status
          this.students.forEach(student => {
            const studentClassIds = this.getStudentClassIds(student.id);

            studentClassIds.forEach(classId => {
              const classObj = this.classes.find(c => c.id === classId);
              if (!classObj) return;

              const isPaid = student.classPaid && student.classPaid[classId];
              let paymentDate = "-";
              let amount = "-";

              if (isPaid) {
                // Find transaction for this payment
                const transaction = this.transactions.find(
                  t => t.studentId === student.id && 
                       t.classDetails.some(cd => cd.classId === classId)
                );

                if (transaction) {
                  paymentDate = new Date(transaction.date).toLocaleDateString("vi-VN");
                  amount = formatCurrency(parseInt(classObj.fee || 0));
                }
              }

              result.push({
                className: classObj.name,
                studentName: student.name,
                status: isPaid ? "Đã đóng" : "Chưa đóng",
                paymentDate,
                amount,
              });
            });
          });
          }

          return result;
        },

        getClassStudentsDetails(classId) {
          const classObj = this.classes.find(c => c.id === classId);
          if (!classObj || !classObj.students) return [];

          return classObj.students
            .map(studentId => {
              const student = this.students.find(s => s.id === studentId);
              if (!student) return null;

              const isPaid = student.classPaid && student.classPaid[classId];

              return {
                id: student.id,
                name: student.name,
                grade: student.grade,
                phone: student.phone || "-",
                status: student.status || "đang học",
                isPaid,
              };
            })
            .filter(student => student !== null);
        },

        getAllStudents() {
          return this.students.map(student => {
            const classes = this.getStudentClasses(student.id)
              .map(c => c.name)
              .join(", ");
              
            return {
              id: student.id,
              name: student.name,
              grade: student.grade,
              phone: student.phone || "-",
              status: student.status || "đang học",
              classes: classes || "-",
            };
          });
        },
      };

      // UI Controller remains mostly the same, just updating specific parts to work with Firebase
      const UIController = {
        // DOM elements and other UI methods remain the same
        elements: {
          // Navigation
          navClassBtn: document.getElementById("navClassBtn"),
          navStudentBtn: document.getElementById("navStudentBtn"),
          navFeeBtn: document.getElementById("navFeeBtn"),
          navReportBtn: document.getElementById("navReportBtn"),

          // Sections
          classSection: document.getElementById("classSection"),
          archivedClassesSection: document.getElementById("archivedClassesSection"),
          classDetailSection: document.getElementById("classDetailSection"),
          studentSection: document.getElementById("studentSection"),
          feeSection: document.getElementById("feeSection"),
          reportSection: document.getElementById("reportSection"),

          // Class Management
          addClassBtn: document.getElementById("addClassBtn"),
          archivedClassesBtn: document.getElementById("archivedClassesBtn"),
          backToClassesBtn: document.getElementById("backToClassesBtn"),
          classTableBody: document.getElementById("classTableBody"),
          archivedClassTableBody: document.getElementById("archivedClassTableBody"),

          // Class Detail
          classDetailName: document.getElementById("classDetailName"),
          classDetailTeacher: document.getElementById("classDetailTeacher"),
          classDetailSchedule: document.getElementById("classDetailSchedule"),
          addStudentToClassBtn: document.getElementById("addStudentToClassBtn"),
          printClassStudentsBtn: document.getElementById("printClassStudentsBtn"),
          exportExcelBtn: document.getElementById("exportExcelBtn"),
          backToClassesListBtn: document.getElementById("backToClassesListBtn"),
          classStudentsTableBody: document.getElementById("classStudentsTableBody"),
          classStudentSearchInput: document.getElementById("classStudentSearchInput"),
          totalStudentsCount: document.getElementById("totalStudentsCount"),
          paidStudentsCount: document.getElementById("paidStudentsCount"),
          unpaidStudentsCount: document.getElementById("unpaidStudentsCount"),
          inactiveStudentsCount: document.getElementById("inactiveStudentsCount"),

          // Student Management
          addStudentBtn: document.getElementById("addStudentBtn"),
          importStudentsBtn: document.getElementById("importStudentsBtn"),
          exportAllStudentsBtn: document.getElementById("exportAllStudentsBtn"),
          studentSearchInput: document.getElementById("studentSearchInput"),
          studentTableBody: document.getElementById("studentTableBody"),

          // Fee Management
          feeStudentSearchInput: document.getElementById("feeStudentSearchInput"),
          searchFeeStudentBtn: document.getElementById("searchFeeStudentBtn"),
          feeSearchResults: document.getElementById("feeSearchResults"),
          feeStudentList: document.getElementById("feeStudentList"),
          transactionsTableBody: document.getElementById("transactionsTableBody"),

          // Report
          totalIncome: document.getElementById("totalIncome"),
          additionalIncome: document.getElementById("additionalIncome"),
          totalExpenses: document.getElementById("totalExpenses"),
          totalProfit: document.getElementById("totalProfit"),
          classPerformanceTableBody: document.getElementById("classPerformanceTableBody"),
          feeStatusTableBody: document.getElementById("feeStatusTableBody"),
          incomeExpenseTableBody: document.getElementById("incomeExpenseTableBody"),
          addIncomeExpenseBtn: document.getElementById("addIncomeExpenseBtn"),
          reportMonth: document.getElementById("reportMonth"),
          reportYear: document.getElementById("reportYear"),
          applyReportFilter: document.getElementById("applyReportFilter"),

          // Modals
          classModal: document.getElementById("classModal"),
          classModalTitle: document.getElementById("classModalTitle"),
          classForm: document.getElementById("classForm"),
          classId: document.getElementById("classId"),
          className: document.getElementById("className"),
          classGrade: document.getElementById("classGrade"),
          classTeacher: document.getElementById("classTeacher"),
          classStartDate: document.getElementById("classStartDate"),
          classSchedule: document.getElementById("classSchedule"),
          classFee: document.getElementById("classFee"),
          classTeacherFee: document.getElementById("classTeacherFee"),
          cancelClassBtn: document.getElementById("cancelClassBtn"),

          studentModal: document.getElementById("studentModal"),
          studentModalTitle: document.getElementById("studentModalTitle"),
          studentForm: document.getElementById("studentForm"),
          studentId: document.getElementById("studentId"),
          studentName: document.getElementById("studentName"),
          studentGrade: document.getElementById("studentGrade"),
          studentPhone: document.getElementById("studentPhone"),
          studentStatus: document.getElementById("studentStatus"),
          studentClasses: document.getElementById("studentClasses"),
          cancelStudentBtn: document.getElementById("cancelStudentBtn"),

          updateStatusModal: document.getElementById("updateStatusModal"),
          statusStudentName: document.getElementById("statusStudentName"),
          statusCurrentStatus: document.getElementById("statusCurrentStatus"),
          newStudentStatus: document.getElementById("newStudentStatus"),
          confirmUpdateStatusBtn: document.getElementById("confirmUpdateStatusBtn"),
          cancelUpdateStatusBtn: document.getElementById("cancelUpdateStatusBtn"),

          importStudentsModal: document.getElementById("importStudentsModal"),
          importData: document.getElementById("importData"),
          processImportBtn: document.getElementById("processImportBtn"),
          cancelImportBtn: document.getElementById("cancelImportBtn"),

          addStudentToClassModal: document.getElementById("addStudentToClassModal"),
          studentToAddSelect: document.getElementById("studentToAddSelect"),
          confirmAddStudentToClassBtn: document.getElementById("confirmAddStudentToClassBtn"),
          cancelAddStudentToClassBtn: document.getElementById("cancelAddStudentToClassBtn"),

          collectFeeModal: document.getElementById("collectFeeModal"),
          feeStudentName: document.getElementById("feeStudentName"),
          feeStudentGrade: document.getElementById("feeStudentGrade"),
          feeStudentPhone: document.getElementById("feeStudentPhone"),
          feeClassesList: document.getElementById("feeClassesList"),
          feeTotalAmount: document.getElementById("feeTotalAmount"),
          confirmFeeBtn: document.getElementById("confirmFeeBtn"),
          cancelFeeBtn: document.getElementById("cancelFeeBtn"),

          receiptModal: document.getElementById("receiptModal"),
          receiptId: document.getElementById("receiptId"),
          receiptDate: document.getElementById("receiptDate"),
          receiptStudentName: document.getElementById("receiptStudentName"),
          receiptStudentGrade: document.getElementById("receiptStudentGrade"),
          receiptStudentPhone: document.getElementById("receiptStudentPhone"),
          receiptDetailsList: document.getElementById("receiptDetailsList"),
          receiptTotal: document.getElementById("receiptTotal"),
          printReceiptBtn: document.getElementById("printReceiptBtn"),
          closeReceiptBtn: document.getElementById("closeReceiptBtn"),

          studentListPrintModal: document.getElementById("studentListPrintModal"),
          printClassName: document.getElementById("printClassName"),
          printClassTeacher: document.getElementById("printClassTeacher"),
          printClassSchedule: document.getElementById("printClassSchedule"),
          printStudentList: document.getElementById("printStudentList"),
          printTotalStudents: document.getElementById("printTotalStudents"),
          printStudentListBtn: document.getElementById("printStudentListBtn"),
          closeStudentListBtn: document.getElementById("closeStudentListBtn"),

          excelInstructionsModal: document.getElementById("excelInstructionsModal"),
          closeExcelInstructionsBtn: document.getElementById("closeExcelInstructionsBtn"),

          deleteConfirmModal: document.getElementById("deleteConfirmModal"),
          deleteModalTitle: document.getElementById("deleteModalTitle"),
          deleteModalMessage: document.getElementById("deleteModalMessage"),
          deleteModalError: document.getElementById("deleteModalError"),
          deleteModalErrorMessage: document.getElementById("deleteModalErrorMessage"),
          confirmDeleteBtn: document.getElementById("confirmDeleteBtn"),
          cancelDeleteBtn: document.getElementById("cancelDeleteBtn"),

          incomeExpenseModal: document.getElementById("incomeExpenseModal"),
          incomeExpenseModalTitle: document.getElementById("incomeExpenseModalTitle"),
          incomeExpenseForm: document.getElementById("incomeExpenseForm"),
          incomeExpenseId: document.getElementById("incomeExpenseId"),
          incomeExpenseDate: document.getElementById("incomeExpenseDate"),
          incomeExpenseType: document.getElementById("incomeExpenseType"),
          incomeExpenseDesc: document.getElementById("incomeExpenseDesc"),
          incomeExpenseAmount: document.getElementById("incomeExpenseAmount"),
          cancelIncomeExpenseBtn: document.getElementById("cancelIncomeExpenseBtn"),

          loadingOverlay: document.getElementById("loadingOverlay"),
          toastNotification: document.getElementById("toastNotification"),
          toastMessage: document.getElementById("toastMessage"),
          toastIcon: document.getElementById("toastIcon"),
        },

        init() {
          this.setupEventListeners();
          this.refreshUI();
        },

        // The rest of the UIController methods remain the same...
        // Note: We're keeping the UI methods intact because they're still valid for Firebase data
        setupEventListeners() {
          // Navigation
          this.elements.navClassBtn.addEventListener("click", () =>
            this.showSection("class")
          );
          this.elements.navStudentBtn.addEventListener("click", () =>
            this.showSection("student")
          );
          this.elements.navFeeBtn.addEventListener("click", () =>
            this.showSection("fee")
          );
          this.elements.navReportBtn.addEventListener("click", () =>
            this.showSection("report")
          );

          // Class Management
          this.elements.addClassBtn.addEventListener("click", () =>
            this.showAddClassModal()
          );
          this.elements.archivedClassesBtn.addEventListener("click", () =>
            this.showArchivedClasses()
          );
          this.elements.backToClassesBtn.addEventListener("click", () =>
            this.showSection("class")
          );
          this.elements.backToClassesListBtn.addEventListener("click", () =>
            this.showSection("class")
          );
          this.elements.printClassStudentsBtn.addEventListener("click", () =>
            this.showPrintStudentList()
          );
          this.elements.exportExcelBtn.addEventListener("click", () =>
            this.exportClassStudentsToExcel()
          );

          // Class Form
          this.elements.classForm.addEventListener("submit", (e) => {
            e.preventDefault();
            this.saveClass();
          });
          this.elements.cancelClassBtn.addEventListener("click", () =>
            this.hideModal("classModal")
          );

          // Student Management
          this.elements.addStudentBtn.addEventListener("click", () =>
            this.showAddStudentModal()
          );
          this.elements.importStudentsBtn.addEventListener("click", () =>
            this.showModal("importStudentsModal")
          );
          this.elements.exportAllStudentsBtn.addEventListener("click", () =>
            this.exportAllStudentsToExcel()
          );
          
          // Student Search
          this.elements.studentSearchInput.addEventListener("input", () =>
            this.filterStudents()
          );
          
          this.elements.studentSearchInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") this.filterStudents();
          });
          
          // Class Student Search
          this.elements.classStudentSearchInput.addEventListener("input", () => {
            const classId = this.elements.classDetailSection.dataset.classId;
            if (classId) this.renderClassStudents(classId);
          });

          // Student Form
          this.elements.studentForm.addEventListener("submit", (e) => {
            e.preventDefault();
            this.saveStudent();
          });
          this.elements.cancelStudentBtn.addEventListener("click", () =>
            this.hideModal("studentModal")
          );

          // Student Status Update
          this.elements.confirmUpdateStatusBtn.addEventListener("click", () =>
            this.updateStudentStatus()
          );
          this.elements.cancelUpdateStatusBtn.addEventListener("click", () =>
            this.hideModal("updateStatusModal")
          );

          // Import Students
          this.elements.processImportBtn.addEventListener("click", () =>
            this.processImport()
          );
          this.elements.cancelImportBtn.addEventListener("click", () =>
            this.hideModal("importStudentsModal")
          );

          // Add Student to Class
          this.elements.addStudentToClassBtn.addEventListener("click", () =>
            this.showAddStudentToClassModal()
          );
          this.elements.confirmAddStudentToClassBtn.addEventListener(
            "click",
            () => this.addStudentToClass()
          );
          this.elements.cancelAddStudentToClassBtn.addEventListener(
            "click",
            () => this.hideModal("addStudentToClassModal")
          );

          // Fee Management
          this.elements.searchFeeStudentBtn.addEventListener("click", () =>
            this.searchStudentForFee()
          );
          this.elements.feeStudentSearchInput.addEventListener(
            "keydown",
            (e) => {
              if (e.key === "Enter") this.searchStudentForFee();
            }
          );

          // Fee Collection
          this.elements.confirmFeeBtn.addEventListener("click", () =>
            this.collectFee()
          );
          this.elements.cancelFeeBtn.addEventListener("click", () =>
            this.hideModal("collectFeeModal")
          );

          // Receipt
          this.elements.printReceiptBtn.addEventListener("click", () =>
            this.printReceipt()
          );
          this.elements.closeReceiptBtn.addEventListener("click", () =>
            this.hideModal("receiptModal")
          );

          // Student List Print
          this.elements.printStudentListBtn.addEventListener("click", () =>
            this.printStudentList()
          );
          this.elements.closeStudentListBtn.addEventListener("click", () =>
            this.hideModal("studentListPrintModal")
          );

          // Excel Export Instructions
          this.elements.closeExcelInstructionsBtn.addEventListener(
            "click",
            () => this.hideModal("excelInstructionsModal")
          );

          // Delete Confirmation
          this.elements.confirmDeleteBtn.addEventListener("click", () =>
            this.confirmDelete()
          );
          this.elements.cancelDeleteBtn.addEventListener("click", () =>
            this.hideModal("deleteConfirmModal")
          );
          
          // Income/Expense Management
          this.elements.addIncomeExpenseBtn.addEventListener("click", () =>
            this.showAddIncomeExpenseModal()
          );
          this.elements.incomeExpenseForm.addEventListener("submit", (e) => {
            e.preventDefault();
            this.saveIncomeExpense();
          });
          this.elements.cancelIncomeExpenseBtn.addEventListener("click", () =>
            this.hideModal("incomeExpenseModal")
          );
        },

        showSection(section) {
          // Hide all sections
          this.elements.classSection.classList.add("hidden");
          this.elements.archivedClassesSection.classList.add("hidden");
          this.elements.classDetailSection.classList.add("hidden");
          this.elements.studentSection.classList.add("hidden");
          this.elements.feeSection.classList.add("hidden");
          this.elements.reportSection.classList.add("hidden");

          // Reset active state on navigation buttons
          this.elements.navClassBtn.classList.remove("bg-white/20");
          this.elements.navStudentBtn.classList.remove("bg-white/20");
          this.elements.navFeeBtn.classList.remove("bg-white/20");
          this.elements.navReportBtn.classList.remove("bg-white/20");

          // Show selected section
          switch (section) {
            case "class":
              this.elements.classSection.classList.remove("hidden");
              this.elements.navClassBtn.classList.add("bg-white/20");
              break;
            case "archivedClasses":
              this.elements.archivedClassesSection.classList.remove("hidden");
              this.elements.navClassBtn.classList.add("bg-white/20");
              break;
            case "classDetail":
              this.elements.classDetailSection.classList.remove("hidden");
              this.elements.navClassBtn.classList.add("bg-white/20");
              break;
            case "student":
              this.elements.studentSection.classList.remove("hidden");
              this.elements.navStudentBtn.classList.add("bg-white/20");
              break;
            case "fee":
              this.elements.feeSection.classList.remove("hidden");
              this.elements.navFeeBtn.classList.add("bg-white/20");
              break;
            case "report":
              this.elements.reportSection.classList.remove("hidden");
              this.elements.navReportBtn.classList.add("bg-white/20");
              this.renderReports();
              this.renderIncomeExpense();
              break;
          }
          
          // Apply fade-in effect to visible section
          document.querySelectorAll('main section:not(.hidden)').forEach(el => {
            el.classList.add('fade-in');
          });
        },

        showArchivedClasses() {
          this.renderArchivedClasses();
          this.showSection("archivedClasses");
        },

        showClassDetail(classId) {
          const classObj = DataStore.classes.find((c) => c.id === classId);
          if (!classObj) {
            showToast("Không tìm thấy lớp học", "error");
            return;
          }

          this.elements.classDetailName.textContent = classObj.name;
          this.elements.classDetailTeacher.textContent = classObj.teacher;
          this.elements.classDetailSchedule.textContent =
            classObj.schedule || "-";

          // Set current class ID as data attribute for later use
          this.elements.classDetailSection.dataset.classId = classId;

          // Clear search input if exists
          if (this.elements.classStudentSearchInput) {
            this.elements.classStudentSearchInput.value = "";
          }

          this.renderClassStudents(classId);
          this.showSection("classDetail");
        },

        renderClasses() {
          const classes = DataStore.classes;
          let html = "";

          if (classes.length === 0) {
            html = `<tr>
                    <td colspan="8" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                      <div class="flex flex-col items-center">
                        <i class="fas fa-folder-open text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                        Chưa có lớp học nào. Hãy thêm lớp học mới!
                      </div>
                    </td>
                  </tr>`;
          } else {
            // Sort classes alphabetically by name
            const sortedClasses = [...classes].sort((a, b) => 
              a.name.localeCompare(b.name, 'vi')
            );
            
            sortedClasses.forEach((classObj, index) => {
              html += `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <td class="py-3 px-4">${index + 1}</td>
                    <td class="py-3 px-4 font-medium">${classObj.name}</td>
                    <td class="py-3 px-4">${classObj.grade}</td>
                    <td class="py-3 px-4">${classObj.teacher}</td>
                    <td class="py-3 px-4">${
                      classObj.schedule || "<span class='text-gray-400 dark:text-gray-600'>-</span>"
                    }</td>
                    <td class="py-3 px-4 font-medium text-primary-600 dark:text-primary-400">${formatCurrency(
                      classObj.fee
                    )}</td>
                    <td class="py-3 px-4">${formatDate(
                      classObj.startDate
                    )}</td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button class="p-1.5 text-blue-500 hover:text-blue-700 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors" title="Xem chi tiết" onclick="UIController.showClassDetail('${
                              classObj.id
                            }')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="p-1.5 text-green-500 hover:text-green-700 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors" title="Sửa lớp học" onclick="UIController.showEditClassModal('${
                              classObj.id
                            }')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="p-1.5 text-amber-500 hover:text-amber-700 bg-amber-50 dark:bg-amber-900/20 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/40 transition-colors" title="Lưu trữ lớp học" onclick="UIController.showArchiveClassConfirmation('${
                              classObj.id
                            }')">
                                <i class="fas fa-archive"></i>
                            </button>
                            <button class="p-1.5 text-red-500 hover:text-red-700 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors" title="Xóa lớp học" onclick="UIController.showDeleteClassConfirmation('${
                              classObj.id
                            }')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            });
          }

          this.elements.classTableBody.innerHTML = html;
        },

        renderArchivedClasses() {
          const classes = DataStore.archivedClasses;
          let html = "";

          if (classes.length === 0) {
            html = `<tr>
                      <td colspan="8" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex flex-col items-center">
                          <i class="fas fa-box-archive text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                          Chưa có lớp học nào được lưu trữ.
                        </div>
                      </td>
                    </tr>`;
          } else {
            // Sort archived classes alphabetically by name
            const sortedClasses = [...classes].sort((a, b) => 
              a.name.localeCompare(b.name, 'vi')
            );
            
            sortedClasses.forEach((classObj, index) => {
              html += `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <td class="py-3 px-4">${index + 1}</td>
                    <td class="py-3 px-4 font-medium">${classObj.name}</td>
                    <td class="py-3 px-4">${classObj.grade}</td>
                    <td class="py-3 px-4">${classObj.teacher}</td>
                    <td class="py-3 px-4">${
                      classObj.schedule || "<span class='text-gray-400 dark:text-gray-600'>-</span>"
                    }</td>
                    <td class="py-3 px-4 font-medium text-primary-600 dark:text-primary-400">${formatCurrency(
                      classObj.fee
                    )}</td>
                    <td class="py-3 px-4">${formatDate(
                      classObj.startDate
                    )}</td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button class="p-1.5 text-blue-500 hover:text-blue-700 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors" title="Khôi phục lớp học" onclick="UIController.restoreClass('${
                              classObj.id
                            }')">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="p-1.5 text-red-500 hover:text-red-700 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors" title="Xóa vĩnh viễn" onclick="UIController.showDeleteArchivedClassConfirmation('${
                              classObj.id
                            }')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            });
          }

          this.elements.archivedClassTableBody.innerHTML = html;
        },

        renderClassStudents(classId) {
          const classObj = DataStore.classes.find((c) => c.id === classId);
          if (!classObj) return;

          // Get all students in this class first
          const allStudents = DataStore.getClassStudentsDetails(classId);
          
          // Filter students if search input has a value
          const searchValue = this.elements.classStudentSearchInput?.value?.toLowerCase().trim() || '';
          
          let students = allStudents;
          if (searchValue) {
            students = allStudents.filter(student => 
              student.name.toLowerCase().includes(searchValue) ||
              student.grade.toLowerCase().includes(searchValue) ||
              (student.phone && student.phone.toLowerCase().includes(searchValue))
            );
          }
          
          // Sort students by name for better readability
          students = [...students].sort((a, b) => a.name.localeCompare(b.name, 'vi'));
          
          let html = "";

          if (students.length === 0) {
            if (searchValue && allStudents.length > 0) {
              html = `<tr>
                      <td colspan="7" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex flex-col items-center">
                          <i class="fas fa-search text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                          Không tìm thấy học sinh nào phù hợp với tìm kiếm.
                        </div>
                      </td>
                    </tr>`;
            } else {
              html = `<tr>
                      <td colspan="7" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex flex-col items-center">
                          <i class="fas fa-user-graduate text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                          Chưa có học sinh nào trong lớp này
                        </div>
                      </td>
                    </tr>`;
            }
          } else {
            let paidCount = 0;
            let inactiveCount = 0;

            students.forEach((student, index) => {
              if (student.isPaid) paidCount++;
              if (student.status !== "đang học") inactiveCount++;

              const statusClass = getStatusClass(student.status);
              const statusText = getStatusText(student.status);

              html += `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <td class="py-3 px-4">${index + 1}</td>
                    <td class="py-3 px-4 font-medium">${student.name}</td>
                    <td class="py-3 px-4">${student.grade}</td>
                    <td class="py-3 px-4">${
                      student.phone !== "-" ? student.phone : "<span class='text-gray-400 dark:text-gray-600'>-</span>"
                    }</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-sm font-medium ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-sm font-medium ${
                          student.isPaid
                            ? "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"
                            : "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300"
                        }">
                            ${
                              student.isPaid
                                ? "Đã đóng"
                                : "Chưa đóng"
                            }
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button class="p-1.5 text-blue-500 hover:text-blue-700 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors" title="Cập nhật trạng thái" onclick="UIController.showUpdateStudentStatusModal('${
                              student.id
                            }')">
                                <i class="fas fa-user-edit"></i>
                            </button>
                            ${
                              !student.isPaid
                                ? `
                                <button class="p-1.5 text-green-500 hover:text-green-700 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors" title="Thu học phí" onclick="UIController.showCollectFeeModal('${student.id}')">
                                    <i class="fas fa-money-bill"></i>
                                </button>
                            `
                                : ""
                            }
                            <button class="p-1.5 text-red-500 hover:text-red-700 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors" title="Xóa khỏi lớp" onclick="UIController.showRemoveStudentFromClassConfirmation('${
                              student.id
                            }', '${classId}')">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            });

            // Update the counters based on all students in the class, not just filtered ones
            this.elements.totalStudentsCount.textContent = allStudents.length;
            
            // Calculate stats from all students
            const allPaidCount = allStudents.filter(s => s.isPaid).length;
            const allInactiveCount = allStudents.filter(s => s.status !== "đang học").length;
            
            this.elements.paidStudentsCount.textContent = allPaidCount;
            this.elements.unpaidStudentsCount.textContent = allStudents.length - allPaidCount;
            this.elements.inactiveStudentsCount.textContent = allInactiveCount;
            
            // Show search result count if filtering
            if (searchValue) {
              html = `
                <tr class="bg-blue-50 dark:bg-blue-900/20">
                  <td colspan="7" class="py-2 px-4 text-blue-700 dark:text-blue-300 border-b dark:border-blue-800">
                    <div class="flex items-center">
                      <i class="fas fa-search mr-2"></i>
                      Hiển thị ${students.length} / ${allStudents.length} học sinh phù hợp với tìm kiếm "${searchValue}"
                    </div>
                  </td>
                </tr>
              ` + html;
            }
          }

          this.elements.classStudentsTableBody.innerHTML = html;
        },

        renderStudents() {
          const students = DataStore.students;
          let html = "";

          if (students.length === 0) {
            html = `<tr>
                      <td colspan="7" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex flex-col items-center">
                          <i class="fas fa-user-graduate text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                          Chưa có học sinh nào. Hãy thêm học sinh mới!
                        </div>
                      </td>
                    </tr>`;
          } else {
            const searchValue = this.elements.studentSearchInput.value
              .toLowerCase()
              .trim();
            let filteredStudents = students;

            // Filter students if search value exists
            if (searchValue) {
              filteredStudents = students.filter(
                (student) =>
                  student.name.toLowerCase().includes(searchValue) ||
                  (student.phone && student.phone.includes(searchValue)) ||
                  student.grade.toLowerCase().includes(searchValue)
              );
            }

            if (filteredStudents.length === 0) {
              html = `<tr>
                        <td colspan="7" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                          <div class="flex flex-col items-center">
                            <i class="fas fa-search text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                            Không tìm thấy học sinh nào phù hợp với tìm kiếm.
                          </div>
                        </td>
                      </tr>`;
            } else {
              // Sort students by name for easier searching with many students
              filteredStudents = [...filteredStudents].sort((a, b) => a.name.localeCompare(b.name, 'vi'));
              
              // Show search result count if filtering
              if (searchValue) {
                html = `
                  <tr class="bg-blue-50 dark:bg-blue-900/20">
                    <td colspan="7" class="py-2 px-4 text-blue-700 dark:text-blue-300 border-b dark:border-blue-800">
                      <div class="flex items-center">
                        <i class="fas fa-search mr-2"></i>
                        Hiển thị ${filteredStudents.length} / ${students.length} học sinh phù hợp với tìm kiếm "${searchValue}"
                      </div>
                    </td>
                  </tr>
                `;
              }
              
              filteredStudents.forEach((student, index) => {
                const studentClasses = DataStore.getStudentClasses(student.id);
                const classNames =
                  studentClasses.map((c) => c.name).join(", ") || "-";

                const statusClass = getStatusClass(student.status);
                const statusText = getStatusText(student.status);

                html += `
                  <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                      <td class="py-3 px-4">${index + 1}</td>
                      <td class="py-3 px-4 font-medium">${student.name}</td>
                      <td class="py-3 px-4">${student.grade}</td>
                      <td class="py-3 px-4">${
                        student.phone !== "-" ? student.phone : "<span class='text-gray-400 dark:text-gray-600'>-</span>"
                      }</td>
                      <td class="py-3 px-4">
                          <span class="px-2 py-1 rounded-full text-sm font-medium ${statusClass}">
                              ${statusText}
                          </span>
                      </td>
                      <td class="py-3 px-4">
                          ${classNames !== "-" ? classNames : "<span class='text-gray-400 dark:text-gray-600'>-</span>"}
                      </td>
                      <td class="py-3 px-4">
                          <div class="flex space-x-2">
                              <button class="p-1.5 text-green-500 hover:text-green-700 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors" title="Thu học phí" onclick="UIController.showCollectFeeModal('${
                                student.id
                              }')">
                                  <i class="fas fa-money-bill"></i>
                              </button>
                              <button class="p-1.5 text-blue-500 hover:text-blue-700 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors" title="Sửa thông tin" onclick="UIController.showEditStudentModal('${
                                student.id
                              }')">
                                  <i class="fas fa-edit"></i>
                              </button>
                              <button class="p-1.5 text-amber-500 hover:text-amber-700 bg-amber-50 dark:bg-amber-900/20 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/40 transition-colors" title="Cập nhật trạng thái" onclick="UIController.showUpdateStudentStatusModal('${
                                student.id
                              }')">
                                  <i class="fas fa-user-edit"></i>
                              </button>
                              <button class="p-1.5 text-red-500 hover:text-red-700 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors" title="Xóa học sinh" onclick="UIController.showDeleteStudentConfirmation('${
                                student.id
                              }')">
                                  <i class="fas fa-trash"></i>
                              </button>
                          </div>
                      </td>
                  </tr>
              `;
              });
            }
          }

          this.elements.studentTableBody.innerHTML = html;
        },

        filterStudents() {
          this.renderStudents();
        },

        renderTransactions() {
          const transactions = DataStore.transactions;
          let html = "";

          if (transactions.length === 0) {
            html = `<tr>
                      <td colspan="6" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex flex-col items-center">
                          <i class="fas fa-receipt text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                          Chưa có giao dịch nào.
                        </div>
                      </td>
                    </tr>`;
          } else {
            // Show most recent transactions first
            const sortedTransactions = [...transactions].sort(
              (a, b) => new Date(b.date) - new Date(a.date)
            );

            sortedTransactions.forEach((transaction) => {
              const classNames = transaction.classDetails
                .map((c) => c.className)
                .join(", ");

              html += `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <td class="py-3 px-4 font-medium text-gray-700 dark:text-gray-300">${transaction.id}</td>
                    <td class="py-3 px-4">${formatDate(
                      transaction.date
                    )}</td>
                    <td class="py-3 px-4 font-medium">${
                      transaction.studentName
                    }</td>
                    <td class="py-3 px-4">${classNames}</td>
                    <td class="py-3 px-4 font-medium text-emerald-600 dark:text-emerald-400">${formatCurrency(
                      transaction.amount
                    )}</td>
                    <td class="py-3 px-4">
                        <button class="p-1.5 text-blue-500 hover:text-blue-700 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors" title="Xem biên lai" onclick="UIController.showReceipt('${
                          transaction.id
                        }')">
                            <i class="fas fa-receipt"></i>
                        </button>
                    </td>
                </tr>
              `;
            });
          }

          this.elements.transactionsTableBody.innerHTML = html;
        },

        renderReports() {
          // Financial summary
          const summary = DataStore.getFinancialSummary();
          this.elements.totalIncome.textContent = formatCurrency(
            summary.totalIncome
          );
          this.elements.additionalIncome.textContent = formatCurrency(
            summary.additionalIncome
          );
          this.elements.totalExpenses.textContent = formatCurrency(
            summary.totalExpenses
          );
          this.elements.totalProfit.textContent = formatCurrency(
            summary.profit
          );

          // Class performance
          const performance = DataStore.getClassPerformance();
          let performanceHtml = "";

          if (performance.length === 0) {
            performanceHtml = `<tr>
                                <td colspan="7" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                                  <div class="flex flex-col items-center">
                                    <i class="fas fa-chart-bar text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                                    Chưa có dữ liệu lớp học.
                                  </div>
                                </td>
                               </tr>`;
          } else {
            // Sort by income or profit for better reporting
            const sortedPerformance = [...performance].sort((a, b) => b.income - a.income);
            
            sortedPerformance.forEach((p) => {
              performanceHtml += `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <td class="py-3 px-4 font-medium">${p.name}</td>
                    <td class="py-3 px-4">${p.teacher}</td>
                    <td class="py-3 px-4 text-center">${p.totalStudents}</td>
                    <td class="py-3 px-4 text-center">${p.paidStudents}</td>
                    <td class="py-3 px-4 font-medium text-blue-600 dark:text-blue-400">${formatCurrency(
                      p.income
                    )}</td>
                    <td class="py-3 px-4 font-medium text-red-600 dark:text-red-400">${formatCurrency(
                      p.teacherCost
                    )}</td>
                    <td class="py-3 px-4 font-medium text-emerald-600 dark:text-emerald-400">${formatCurrency(
                      p.profit
                    )}</td>
                </tr>
              `;
            });
          }

          this.elements.classPerformanceTableBody.innerHTML = performanceHtml;

          // Fee status
          const feeStatus = DataStore.getFeeStatus();
          let feeStatusHtml = "";

          if (feeStatus.length === 0) {
            feeStatusHtml = `<tr>
                              <td colspan="5" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                                <div class="flex flex-col items-center">
                                  <i class="fas fa-receipt text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                                  Chưa có dữ liệu học phí.
                                </div>
                              </td>
                             </tr>`;
          } else {
            // Sort by class name then student name for easier reading
            const sortedFeeStatus = [...feeStatus].sort((a, b) => {
              const classCompare = a.className.localeCompare(b.className, 'vi');
              if (classCompare !== 0) return classCompare;
              return a.studentName.localeCompare(b.studentName, 'vi');
            });
            
            sortedFeeStatus.forEach((f) => {
              const statusClass =
                f.status === "Đã đóng"
                  ? "text-green-600 dark:text-green-400 font-medium"
                  : "text-red-600 dark:text-red-400 font-medium";

              feeStatusHtml += `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <td class="py-3 px-4 font-medium">${f.className}</td>
                    <td class="py-3 px-4">${f.studentName}</td>
                    <td class="py-3 px-4 ${statusClass}">${f.status}</td>
                    <td class="py-3 px-4">${f.paymentDate}</td>
                    <td class="py-3 px-4 font-medium">${f.amount}</td>
                </tr>
              `;
            });
          }

          this.elements.feeStatusTableBody.innerHTML = feeStatusHtml;
        },

        renderIncomeExpense() {
          const monthFilter = parseInt(document.getElementById('reportMonth').value);
          const yearFilter = parseInt(document.getElementById('reportYear').value);
          
          // Filter income/expense entries by month/year if selected
          let filteredEntries = DataStore.incomeExpense;
          if (monthFilter > 0 || yearFilter > 0) {
            filteredEntries = DataStore.incomeExpense.filter(entry => {
              const entryDate = new Date(entry.date);
              const entryMonth = entryDate.getMonth() + 1; // JavaScript months are 0-based
              const entryYear = entryDate.getFullYear();
              
              // Apply filters
              if (monthFilter > 0 && yearFilter > 0) {
                return entryMonth === monthFilter && entryYear === yearFilter;
              } else if (monthFilter > 0) {
                return entryMonth === monthFilter;
              } else if (yearFilter > 0) {
                return entryYear === yearFilter;
              }
              return true;
            });
          }
          
          let html = "";

          if (filteredEntries.length === 0) {
            html = `<tr>
                      <td colspan="5" class="py-8 px-4 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex flex-col items-center">
                          <i class="fas fa-file-invoice-dollar text-4xl mb-4 text-gray-300 dark:text-gray-600"></i>
                          Chưa có khoản thu chi bổ sung.
                        </div>
                      </td>
                    </tr>`;
          } else {
            // Sort by date, newest first
            const sortedEntries = [...filteredEntries].sort(
              (a, b) => new Date(b.date) - new Date(a.date)
            );
            
            sortedEntries.forEach((entry) => {
              const typeClass = entry.type === 'thu' 
                ? "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"
                : "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300";
                
              const typeText = entry.type === 'thu' ? "Khoản thu" : "Khoản chi";

              html += `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <td class="py-3 px-4">${formatDate(entry.date)}</td>
                    <td class="py-3 px-4 font-medium">${entry.description}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-sm font-medium ${typeClass}">
                            ${typeText}
                        </span>
                    </td>
                    <td class="py-3 px-4 font-medium ${entry.type === 'thu' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                        ${formatCurrency(entry.amount)}
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button class="p-1.5 text-blue-500 hover:text-blue-700 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors" title="Sửa" onclick="UIController.showEditIncomeExpenseModal('${entry.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="p-1.5 text-red-500 hover:text-red-700 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors" title="Xóa" onclick="UIController.showDeleteIncomeExpenseConfirmation('${entry.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
              `;
            });
          }

          this.elements.incomeExpenseTableBody.innerHTML = html;
        },
        
        showAddIncomeExpenseModal() {
          // Reset form
          this.elements.incomeExpenseModalTitle.innerHTML = '<div class="p-2 bg-teal-100 dark:bg-teal-900/30 text-teal-600 dark:text-teal-400 rounded-full mr-3"><i class="fas fa-file-invoice-dollar"></i></div>Thêm khoản thu chi';
          this.elements.incomeExpenseForm.reset();
          this.elements.incomeExpenseId.value = "";
          
          // Set default date to today
          const today = new Date().toISOString().split("T")[0];
          this.elements.incomeExpenseDate.value = today;
          
          this.showModal("incomeExpenseModal");
        },
        
        showEditIncomeExpenseModal(id) {
          const entry = DataStore.incomeExpense.find(e => e.id === id);
          if (!entry) {
            showToast("Không tìm thấy khoản thu chi", "error");
            return;
          }
          
          // Set modal title and populate form
          this.elements.incomeExpenseModalTitle.innerHTML = '<div class="p-2 bg-teal-100 dark:bg-teal-900/30 text-teal-600 dark:text-teal-400 rounded-full mr-3"><i class="fas fa-edit"></i></div>Sửa khoản thu chi';
          this.elements.incomeExpenseId.value = id;
          this.elements.incomeExpenseDate.value = entry.date;
          this.elements.incomeExpenseType.value = entry.type;
          this.elements.incomeExpenseDesc.value = entry.description;
          this.elements.incomeExpenseAmount.value = entry.amount;
          
          this.showModal("incomeExpenseModal");
        },
        
        saveIncomeExpense() {
          // Show loading
          showLoading();
          
          const entryData = {
            date: this.elements.incomeExpenseDate.value,
            type: this.elements.incomeExpenseType.value,
            description: this.elements.incomeExpenseDesc.value,
            amount: this.elements.incomeExpenseAmount.value,
          };
          
          const entryId = this.elements.incomeExpenseId.value;
          
          if (entryId) {
            // Update existing entry
            DataStore.updateIncomeExpense(entryId, entryData)
              .then(result => {
                if (result) {
                  showToast("Cập nhật khoản thu chi thành công", "success");
                  this.hideModal("incomeExpenseModal");
                  this.renderIncomeExpense();
                  this.renderReports();
                } else {
                  showToast("Lỗi khi cập nhật khoản thu chi", "error");
                }
                hideLoading();
              })
              .catch(error => {
                console.error("Error updating income/expense:", error);
                showToast("Lỗi khi cập nhật khoản thu chi: " + error.message, "error");
                hideLoading();
              });
          } else {
            // Add new entry
            DataStore.addIncomeExpense(entryData)
              .then(newEntryId => {
                if (newEntryId) {
                  showToast("Thêm khoản thu chi thành công", "success");
                  this.hideModal("incomeExpenseModal");
                  this.renderIncomeExpense();
                  this.renderReports();
                } else {
                  showToast("Lỗi khi thêm khoản thu chi", "error");
                }
                hideLoading();
              })
              .catch(error => {
                console.error("Error adding income/expense:", error);
                showToast("Lỗi khi thêm khoản thu chi: " + error.message, "error");
                hideLoading();
              });
          }
        },
        
        showDeleteIncomeExpenseConfirmation(id) {
          const entry = DataStore.incomeExpense.find(e => e.id === id);
          if (!entry) return;
          
          const typeText = entry.type === 'thu' ? "khoản thu" : "khoản chi";
          
          this.elements.deleteModalTitle.innerHTML = '<div class="p-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-full mr-3"><i class="fas fa-exclamation-triangle"></i></div>Xác nhận xóa';
          this.elements.deleteModalMessage.innerHTML = `Bạn có chắc chắn muốn xóa ${typeText} <span class="font-medium">"${entry.description}"</span>? Thao tác này không thể hoàn tác.`;
          
          // Hide any previous error message
          this.elements.deleteModalError.classList.add("hidden");
          
          // Restore button style
          this.elements.confirmDeleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i> Xóa';
          this.elements.confirmDeleteBtn.classList.remove(
            "from-yellow-500", "to-yellow-600", "hover:from-yellow-600", "hover:to-yellow-700"
          );
          this.elements.confirmDeleteBtn.classList.add(
            "from-red-500", "to-red-600", "hover:from-red-600", "hover:to-red-700"
          );
          
          // Set action for confirmation
          this.elements.confirmDeleteBtn.onclick = () => {
            // Show loading
            showLoading();
            
            DataStore.deleteIncomeExpense(id)
              .then(result => {
                if (result.success) {
                  showToast("Xóa khoản thu chi thành công", "success");
                  this.hideModal("deleteConfirmModal");
                  this.renderIncomeExpense();
                  this.renderReports();
                } else {
                  this.elements.deleteModalError.classList.remove("hidden");
                  this.elements.deleteModalErrorMessage.textContent = result.error;
                }
                hideLoading();
              })
              .catch(error => {
                console.error("Error deleting income/expense:", error);
                this.elements.deleteModalError.classList.remove("hidden");
                this.elements.deleteModalErrorMessage.textContent = "Lỗi khi xóa khoản thu chi: " + error.message;
                hideLoading();
              });
          };
          
          this.showModal("deleteConfirmModal");
        },

        refreshStudentClassSelect() {
          const select = this.elements.studentClasses;
          const classes = DataStore.classes;

          // Clear current options except the first one
          while (select.options.length > 1) {
            select.remove(1);
          }

          // Add class options
          classes.forEach((classObj) => {
            const option = document.createElement("option");
            option.value = classObj.id;
            option.textContent = `${classObj.name} (${classObj.grade})`;
            select.appendChild(option);
          });
        },

        refreshUI() {
          // Show the class section by default
          this.showSection("class");
          
          // Set up month/year selectors for the report section
          const currentMonth = new Date().getMonth() + 1; // JavaScript months are 0-based
          const currentYear = new Date().getFullYear();
          
          // Set default values
          if (this.elements.reportMonth) {
            this.elements.reportMonth.value = currentMonth.toString();
          }
          
          if (this.elements.reportYear) {
            this.elements.reportYear.value = currentYear.toString();
          }
        },

        // Modal Methods
        showModal(modalId) {
          document.getElementById(modalId).classList.remove("hidden");
        },

        hideModal(modalId) {
          document.getElementById(modalId).classList.add("hidden");
        },

        // Class Management
        showAddClassModal() {
          // Reset form
          this.elements.classModalTitle.innerHTML = '<div class="p-2 bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full mr-3"><i class="fas fa-chalkboard-teacher"></i></div>Thêm lớp học';
          this.elements.classForm.reset();
          this.elements.classId.value = "";

          // Set default date to today
          const today = new Date().toISOString().split("T")[0];
          this.elements.classStartDate.value = today;

          this.showModal("classModal");
        },

        showEditClassModal(classId) {
          const classObj = DataStore.classes.find((c) => c.id === classId);
          if (!classObj) {
            showToast("Không tìm thấy lớp học", "error");
            return;
          }

          // Set modal title and populate form
          this.elements.classModalTitle.innerHTML = '<div class="p-2 bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full mr-3"><i class="fas fa-edit"></i></div>Sửa lớp học';
          this.elements.classId.value = classId;
          this.elements.className.value = classObj.name;
          this.elements.classGrade.value = classObj.grade;
          this.elements.classTeacher.value = classObj.teacher;
          this.elements.classStartDate.value = classObj.startDate;
          this.elements.classSchedule.value = classObj.schedule || "";
          this.elements.classFee.value = classObj.fee;
          this.elements.classTeacherFee.value = classObj.teacherFee || "";

          this.showModal("classModal");
        },

        saveClass() {
          // Show loading
          showLoading();
          
          const classData = {
            name: this.elements.className.value,
            grade: this.elements.classGrade.value,
            teacher: this.elements.classTeacher.value,
            startDate: this.elements.classStartDate.value,
            schedule: this.elements.classSchedule.value,
            fee: this.elements.classFee.value,
            teacherFee: this.elements.classTeacherFee.value,
          };

          const classId = this.elements.classId.value;

            if (classId) {
              // Update existing class
            DataStore.updateClass(classId, classData)
              .then(result => {
              if (result) {
                showToast("Cập nhật lớp học thành công", "success");
                this.hideModal("classModal");
          
          // Force refresh the UI for immediate feedback
          this.renderClasses();
          
          // If we're in class detail view for this class, refresh it
          if (!this.elements.classDetailSection.classList.contains('hidden') && 
              this.elements.classDetailSection.dataset.classId === classId) {
            this.elements.classDetailName.textContent = classData.name;
            this.elements.classDetailTeacher.textContent = classData.teacher;
            this.elements.classDetailSchedule.textContent = classData.schedule || "-";
            this.renderClassStudents(classId);
          }
              } else {
                showToast("Lỗi khi cập nhật lớp học", "error");
              }
                hideLoading();
              })
              .catch(error => {
                console.error("Error updating class:", error);
                showToast("Lỗi khi cập nhật lớp học: " + error.message, "error");
                hideLoading();
              });
            } else {
              // Add new class
            DataStore.addClass(classData)
              .then(newClassId => {
              if (newClassId) {
                showToast("Thêm lớp học thành công", "success");
                this.hideModal("classModal");
          
          // Force refresh the UI for immediate feedback
          this.renderClasses();
              } else {
                showToast("Lỗi khi thêm lớp học", "error");
              }
                hideLoading();
              })
              .catch(error => {
                console.error("Error adding class:", error);
                showToast("Lỗi khi thêm lớp học: " + error.message, "error");
            hideLoading();
              });
          }
        },

        showArchiveClassConfirmation(classId) {
          const classObj = DataStore.classes.find((c) => c.id === classId);
          if (!classObj) return;

          this.elements.deleteModalTitle.innerHTML = '<div class="p-2 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 rounded-full mr-3"><i class="fas fa-archive"></i></div>Lưu trữ lớp học';
          this.elements.deleteModalMessage.innerHTML = `Bạn có chắc chắn muốn lưu trữ lớp học <span class="font-medium">"${classObj.name}"</span>?`;

          // Hide any previous error message
          this.elements.deleteModalError.classList.add("hidden");

          // Change button text
          this.elements.confirmDeleteBtn.innerHTML = '<i class="fas fa-archive mr-2"></i> Lưu trữ';
          this.elements.confirmDeleteBtn.classList.remove(
            "from-red-500", "to-red-600", "hover:from-red-600", "hover:to-red-700"
          );
          this.elements.confirmDeleteBtn.classList.add(
            "from-yellow-500", "to-yellow-600", "hover:from-yellow-600", "hover:to-yellow-700"
          );

          // Set action for confirmation
          this.elements.confirmDeleteBtn.onclick = () => {
            this.archiveClass(classId);
            this.hideModal("deleteConfirmModal");
          };

          this.showModal("deleteConfirmModal");
        },

        archiveClass(classId) {
          // Show loading
          showLoading();
          
          DataStore.archiveClass(classId)
            .then(result => {
            if (result) {
              showToast("Lớp học đã được lưu trữ thành công", "success");
            } else {
              showToast("Lỗi khi lưu trữ lớp học", "error");
            }
            hideLoading();
            })
            .catch(error => {
              console.error("Error archiving class:", error);
              showToast("Lỗi khi lưu trữ lớp học: " + error.message, "error");
              hideLoading();
            });
        },

        restoreClass(classId) {
          // Show loading
          showLoading();
          
          DataStore.restoreClass(classId)
            .then(result => {
            if (result) {
              showToast("Lớp học đã được khôi phục thành công", "success");
            } else {
              showToast("Lỗi khi khôi phục lớp học", "error");
            }
            hideLoading();
            })
            .catch(error => {
              console.error("Error restoring class:", error);
              showToast("Lỗi khi khôi phục lớp học: " + error.message, "error");
              hideLoading();
            });
        },

        showDeleteClassConfirmation(classId) {
          const classObj = DataStore.classes.find((c) => c.id === classId);
          if (!classObj) return;

          this.elements.deleteModalTitle.innerHTML = '<div class="p-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-full mr-3"><i class="fas fa-exclamation-triangle"></i></div>Xác nhận xóa lớp học';
          this.elements.deleteModalMessage.innerHTML = `Bạn có chắc chắn muốn xóa lớp học <span class="font-medium">"${classObj.name}"</span>? Thao tác này không thể hoàn tác.`;

          // Hide any previous error message
          this.elements.deleteModalError.classList.add("hidden");

          // Restore button style
          this.elements.confirmDeleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i> Xóa lớp học';
          this.elements.confirmDeleteBtn.classList.remove(
            "from-yellow-500", "to-yellow-600", "hover:from-yellow-600", "hover:to-yellow-700"
          );
          this.elements.confirmDeleteBtn.classList.add(
            "from-red-500", "to-red-600", "hover:from-red-600", "hover:to-red-700"
          );

          // Set action for confirmation
          this.elements.confirmDeleteBtn.onclick = () => {
            // Show loading
            showLoading();
            
            DataStore.deleteClass(classId)
              .then(result => {
              if (result.success) {
                showToast("Xóa lớp học thành công", "success");
                this.hideModal("deleteConfirmModal");
              } else {
                this.elements.deleteModalError.classList.remove("hidden");
                this.elements.deleteModalErrorMessage.textContent = result.error;
              }
              hideLoading();
              })
              .catch(error => {
                console.error("Error deleting class:", error);
                this.elements.deleteModalError.classList.remove("hidden");
                this.elements.deleteModalErrorMessage.textContent = "Lỗi khi xóa lớp học: " + error.message;
                hideLoading();
              });
          };

          this.showModal("deleteConfirmModal");
        },

        showDeleteArchivedClassConfirmation(classId) {
          const classObj = DataStore.archivedClasses.find(
            (c) => c.id === classId
          );
          if (!classObj) return;

          this.elements.deleteModalTitle.innerHTML = '<div class="p-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-full mr-3"><i class="fas fa-exclamation-triangle"></i></div>Xác nhận xóa lớp học đã lưu trữ';
          this.elements.deleteModalMessage.innerHTML = `Bạn có chắc chắn muốn xóa lớp học <span class="font-medium">"${classObj.name}"</span>? Thao tác này không thể hoàn tác.`;

          // Hide any previous error message
          this.elements.deleteModalError.classList.add("hidden");

          // Restore button style
          this.elements.confirmDeleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i> Xóa lớp học';
          this.elements.confirmDeleteBtn.classList.remove(
            "from-yellow-500", "to-yellow-600", "hover:from-yellow-600", "hover:to-yellow-700"
          );
          this.elements.confirmDeleteBtn.classList.add(
            "from-red-500", "to-red-600", "hover:from-red-600", "hover:to-red-700"
          );

          // Set action for confirmation
          this.elements.confirmDeleteBtn.onclick = () => {
            // Show loading
            showLoading();
            
            DataStore.deleteArchivedClass(classId)
              .then(result => {
              if (result.success) {
                showToast("Xóa lớp học thành công", "success");
                this.hideModal("deleteConfirmModal");
              } else {
                this.elements.deleteModalError.classList.remove("hidden");
                this.elements.deleteModalErrorMessage.textContent = result.error;
              }
              hideLoading();
              })
              .catch(error => {
                console.error("Error deleting archived class:", error);
                this.elements.deleteModalError.classList.remove("hidden");
                this.elements.deleteModalErrorMessage.textContent = "Lỗi khi xóa lớp học: " + error.message;
                hideLoading();
              });
          };

          this.showModal("deleteConfirmModal");
        },

        // Student Management
        showAddStudentModal() {
          // Reset form
          this.elements.studentModalTitle.innerHTML = '<div class="p-2 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-full mr-3"><i class="fas fa-user-graduate"></i></div>Thêm học sinh';
          this.elements.studentForm.reset();
          this.elements.studentId.value = "";

          // Reset class selection
          for (
            let i = 0;
            i < this.elements.studentClasses.options.length;
            i++
          ) {
            this.elements.studentClasses.options[i].selected = false;
          }

          // Default to "đang học" status
          this.elements.studentStatus.value = "đang học";

          this.showModal("studentModal");
        },

        showEditStudentModal(studentId) {
          const student = DataStore.students.find((s) => s.id === studentId);
          if (!student) {
            showToast("Không tìm thấy học sinh", "error");
            return;
          }

          // Set modal title and populate form
          this.elements.studentModalTitle.innerHTML = '<div class="p-2 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-full mr-3"><i class="fas fa-edit"></i></div>Sửa thông tin học sinh';
          this.elements.studentId.value = studentId;
          this.elements.studentName.value = student.name;
          this.elements.studentGrade.value = student.grade;
          this.elements.studentPhone.value = student.phone || "";
          this.elements.studentStatus.value = student.status || "đang học";

          // Set selected classes
          const studentClassIds = DataStore.getStudentClassIds(studentId);

          for (
            let i = 0;
            i < this.elements.studentClasses.options.length;
            i++
          ) {
            const option = this.elements.studentClasses.options[i];
            option.selected = studentClassIds.includes(option.value);
          }

          this.showModal("studentModal");
        },

        showUpdateStudentStatusModal(studentId) {
          const student = DataStore.students.find((s) => s.id === studentId);
          if (!student) {
            showToast("Không tìm thấy học sinh", "error");
            return;
          }

          // Populate student info
          this.elements.statusStudentName.textContent = student.name;
          
          // Get status text and apply appropriate class
          const statusText = getStatusText(student.status || "đang học");
          const statusElement = this.elements.statusCurrentStatus;
          statusElement.textContent = statusText;
          
          // Reset classes
          statusElement.className = "ml-2 font-medium px-2 py-0.5 rounded";
          
          // Add appropriate status class
          if (student.status === "đang học") {
            statusElement.classList.add("bg-green-100", "text-green-800", "dark:bg-green-900/30", "dark:text-green-300");
          } else if (student.status === "tạm nghỉ") {
            statusElement.classList.add("bg-yellow-100", "text-yellow-800", "dark:bg-yellow-900/30", "dark:text-yellow-300");
          } else if (student.status === "đã nghỉ học") {
            statusElement.classList.add("bg-red-100", "text-red-800", "dark:bg-red-900/30", "dark:text-red-300");
          }
          
          this.elements.newStudentStatus.value = student.status || "đang học";

          // Store student ID for later use
          this.elements.updateStatusModal.dataset.studentId = studentId;

          this.showModal("updateStatusModal");
        },

        updateStudentStatus() {
          const studentId = this.elements.updateStatusModal.dataset.studentId;
          if (!studentId) {
            showToast("Lỗi: Không tìm thấy ID học sinh", "error");
            return;
          }

          // Show loading
          showLoading();
          
          const newStatus = this.elements.newStudentStatus.value;
          
          DataStore.updateStudentStatus(studentId, newStatus)
            .then(result => {
            if (result) {
              showToast("Cập nhật tình trạng học sinh thành công", "success");
              this.hideModal("updateStatusModal");
            } else {
              showToast("Lỗi khi cập nhật tình trạng học sinh", "error");
            }
            hideLoading();
            })
            .catch(error => {
              console.error("Error updating student status:", error);
              showToast("Lỗi khi cập nhật tình trạng học sinh: " + error.message, "error");
              hideLoading();
            });
        },

        saveStudent() {
          // Show loading
          showLoading();
          
          // Get selected class IDs
          const selectedOptions = Array.from(
            this.elements.studentClasses.selectedOptions
          );
          const classIds = selectedOptions
            .map((option) => option.value)
            .filter((id) => id !== "");

          const studentData = {
            name: this.elements.studentName.value,
            grade: this.elements.studentGrade.value,
            phone: this.elements.studentPhone.value,
            status: this.elements.studentStatus.value,
            classIds,
          };

          const studentId = this.elements.studentId.value;

            if (studentId) {
              // Update existing student
            DataStore.updateStudent(studentId, studentData)
              .then(result => {
              if (result) {
                showToast("Cập nhật thông tin học sinh thành công", "success");
                this.hideModal("studentModal");
              } else {
                showToast("Lỗi khi cập nhật thông tin học sinh", "error");
              }
                hideLoading();
              })
              .catch(error => {
                console.error("Error updating student:", error);
                showToast("Lỗi khi cập nhật học sinh: " + error.message, "error");
                hideLoading();
              });
            } else {
              // Add new student
            DataStore.addStudent(studentData)
              .then(newStudentId => {
              if (newStudentId) {
                showToast("Thêm học sinh thành công", "success");
                this.hideModal("studentModal");
              } else {
                showToast("Lỗi khi thêm học sinh", "error");
              }
                hideLoading();
              })
              .catch(error => {
                console.error("Error adding student:", error);
                showToast("Lỗi khi thêm học sinh: " + error.message, "error");
            hideLoading();
              });
          }
        },

        showDeleteStudentConfirmation(studentId) {
          const student = DataStore.students.find((s) => s.id === studentId);
          if (!student) return;

          this.elements.deleteModalTitle.innerHTML = '<div class="p-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-full mr-3"><i class="fas fa-exclamation-triangle"></i></div>Xác nhận xóa học sinh';
          this.elements.deleteModalMessage.innerHTML = `Bạn có chắc chắn muốn xóa học sinh <span class="font-medium">"${student.name}"</span>? Thao tác này không thể hoàn tác.`;

          // Hide any previous error message
          this.elements.deleteModalError.classList.add("hidden");

          // Ensure button has correct styling
          this.elements.confirmDeleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i> Xóa học sinh';
          this.elements.confirmDeleteBtn.classList.remove(
            "from-yellow-500", "to-yellow-600", "hover:from-yellow-600", "hover:to-yellow-700"
          );
          this.elements.confirmDeleteBtn.classList.add(
            "from-red-500", "to-red-600", "hover:from-red-600", "hover:to-red-700"
          );

          // Set action for confirmation
          this.elements.confirmDeleteBtn.onclick = () => {
            // Show loading
            showLoading();
            
            DataStore.deleteStudent(studentId)
              .then(result => {
              if (result.success) {
                showToast("Xóa học sinh thành công", "success");
                this.hideModal("deleteConfirmModal");
              } else {
                this.elements.deleteModalError.classList.remove("hidden");
                this.elements.deleteModalErrorMessage.textContent = result.error;
              }
              hideLoading();
              })
              .catch(error => {
                console.error("Error deleting student:", error);
                this.elements.deleteModalError.classList.remove("hidden");
                this.elements.deleteModalErrorMessage.textContent = "Lỗi khi xóa học sinh: " + error.message;
                hideLoading();
              });
          };

          this.showModal("deleteConfirmModal");
        },

        processImport() {
          const data = this.elements.importData.value;
          if (!data.trim()) {
            showToast("Vui lòng nhập dữ liệu học sinh", "error");
            return;
          }

          // Show loading
          showLoading();
          
          const lines = data.split("\n").filter((line) => line.trim());

          // Create a batch for better performance
          const batch = firebase.firestore().batch();
          let successCount = 0;
          let errorLines = [];

          // Process each line
          const promises = lines.map((line, index) => {
            const [name, grade, phone] = line.split(",").map(item => item.trim());
  
              if (!name || !grade) {
              errorLines.push({ line: index + 1, content: line.trim() });
              return Promise.resolve();
              }
  
            // Create a new student reference
            const studentRef = db.collection('students').doc();
            
            // Add to batch
            batch.set(studentRef, {createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                name,
                grade,
                phone: phone || "",
                status: "đang học",
              classPaid: {}
            });
            
            successCount++;
            return Promise.resolve();
          });
          
          // Wait for all validations to complete, then commit the batch
          Promise.all(promises)
            .then(() => {
              if (successCount === 0) {
                showToast(`Không có dữ liệu hợp lệ để nhập`, "error");
                hideLoading();
                return;
              }
              
              return batch.commit();
            })
            .then(() => {
              if (errorLines.length > 0) {
              showToast(
                  `Đã nhập ${successCount} học sinh thành công, ${errorLines.length} dòng bị lỗi`,
                  "warning"
              );
              } else {
                showToast(`Đã nhập ${successCount} học sinh thành công`, "success");
            }
            
            this.hideModal("importStudentsModal");
            this.elements.importData.value = "";
            hideLoading();
            })
            .catch(error => {
              console.error("Error importing students:", error);
              showToast(`Lỗi khi nhập dữ liệu: ${error.message}`, "error");
              hideLoading();
            });
        },

        // Class Students Management
        showAddStudentToClassModal() {
          const classId = this.elements.classDetailSection.dataset.classId;
          if (!classId) return;

          // Populate student dropdown
          const select = this.elements.studentToAddSelect;
          const classObj = DataStore.classes.find((c) => c.id === classId);

          if (!classObj) {
            showToast("Không tìm thấy lớp học", "error");
            return;
          }

          // Clear current options except the first one
          while (select.options.length > 1) {
            select.remove(1);
          }

          // Get students not in this class
          const studentsInClass = classObj.students || [];
          const availableStudents = DataStore.students.filter(
            (student) => !studentsInClass.includes(student.id)
          );

          if (availableStudents.length === 0) {
            showToast("Tất cả học sinh đã được thêm vào lớp này", "info");
            return;
          }

          // Sort available students by name for easier selection
          const sortedStudents = [...availableStudents].sort((a, b) => 
            a.name.localeCompare(b.name, 'vi')
          );

          // Add student options
          sortedStudents.forEach((student) => {
            const option = document.createElement("option");
            option.value = student.id;
            option.textContent = `${student.name} (${student.grade})`;
            
            // Add tooltip about inactive students
            if (student.status !== "đang học") {
              option.textContent += ` - ${getStatusText(student.status)}`;
            }
            
            select.appendChild(option);
          });

          this.showModal("addStudentToClassModal");
        },

        addStudentToClass() {
          const classId = this.elements.classDetailSection.dataset.classId;
          const studentId = this.elements.studentToAddSelect.value;

          if (!classId || !studentId) {
            showToast("Vui lòng chọn học sinh", "error");
            return;
          }

          // Show loading
          showLoading();
          
          DataStore.addStudentToClass(studentId, classId)
            .then(result => {
            if (result) {
              showToast("Thêm học sinh vào lớp thành công", "success");
              this.hideModal("addStudentToClassModal");
              this.renderClassStudents(classId);
            } else {
              showToast("Lỗi khi thêm học sinh vào lớp", "error");
            }
            hideLoading();
            })
            .catch(error => {
              console.error("Error adding student to class:", error);
              showToast("Lỗi khi thêm học sinh vào lớp: " + error.message, "error");
              hideLoading();
            });
        },

        showRemoveStudentFromClassConfirmation(studentId, classId) {
          const student = DataStore.students.find((s) => s.id === studentId);
          const classObj = DataStore.classes.find((c) => c.id === classId);

          if (!student || !classObj) return;

          this.elements.deleteModalTitle.innerHTML = '<div class="p-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-full mr-3"><i class="fas fa-exclamation-triangle"></i></div>Xác nhận xóa học sinh khỏi lớp';
          this.elements.deleteModalMessage.innerHTML = `Bạn có chắc chắn muốn xóa học sinh <span class="font-medium">"${student.name}"</span> khỏi lớp <span class="font-medium">"${classObj.name}"</span>?`;

          // Hide any previous error message
          this.elements.deleteModalError.classList.add("hidden");

          // Ensure button has correct styling
          this.elements.confirmDeleteBtn.innerHTML = '<i class="fas fa-user-minus mr-2"></i> Xóa khỏi lớp';
          this.elements.confirmDeleteBtn.classList.remove(
            "from-yellow-500", "to-yellow-600", "hover:from-yellow-600", "hover:to-yellow-700"
          );
          this.elements.confirmDeleteBtn.classList.add(
            "from-red-500", "to-red-600", "hover:from-red-600", "hover:to-red-700"
          );

          // Set action for confirmation
          this.elements.confirmDeleteBtn.onclick = () => {
            // Show loading
            showLoading();
            
            DataStore.removeStudentFromClass(studentId, classId)
              .then(result => {
              if (result.success) {
                showToast("Xóa học sinh khỏi lớp thành công", "success");
                this.hideModal("deleteConfirmModal");
                this.renderClassStudents(classId);
              } else {
                this.elements.deleteModalError.classList.remove("hidden");
                this.elements.deleteModalErrorMessage.textContent = result.error;
              }
              hideLoading();
              })
              .catch(error => {
                console.error("Error removing student from class:", error);
                this.elements.deleteModalError.classList.remove("hidden");
                this.elements.deleteModalErrorMessage.textContent = "Lỗi khi xóa học sinh khỏi lớp: " + error.message;
                hideLoading();
              });
          };

          this.showModal("deleteConfirmModal");
        },

        // Fee Management
        searchStudentForFee() {
          const searchValue = this.elements.feeStudentSearchInput.value.trim();
          if (!searchValue) {
            showToast("Vui lòng nhập tên, khối hoặc số điện thoại học sinh", "error");
            return;
          }

          // Show loading
          showLoading();
          
            const searchLower = searchValue.toLowerCase();
            const matchingStudents = DataStore.students.filter(
              (student) =>
                student.name.toLowerCase().includes(searchLower) ||
                (student.phone && student.phone.includes(searchValue)) ||
                student.grade.toLowerCase().includes(searchLower)
            );
  
            if (matchingStudents.length === 0) {
              showToast(
                "Không tìm thấy học sinh nào phù hợp với tìm kiếm",
                "info"
              );
              this.elements.feeSearchResults.classList.add("hidden");
              
              // Hide loading
              hideLoading();
              return;
            }
  
            // Show results
            this.elements.feeSearchResults.classList.remove("hidden");
            this.elements.feeSearchResults.classList.add("fade-in");
  
            // Sort results alphabetically by name for easier searching with many students
            const sortedStudents = [...matchingStudents].sort((a, b) => 
              a.name.localeCompare(b.name, 'vi')
            );
            
            let html = "";
            let resultCount = sortedStudents.length;
            
            // Show result count if more than one student is found
            if (resultCount > 1) {
              html += `
                <div class="mb-4 py-2 px-4 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 rounded-lg">
                  <p class="flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    Đã tìm thấy ${resultCount} học sinh phù hợp với từ khóa "${searchValue}"
                  </p>
                </div>
              `;
            }
            
            sortedStudents.forEach((student) => {
              const unpaidClasses = DataStore.getUnpaidClasses(student.id);
              const canPayFees = unpaidClasses.length > 0;
              
              // Get list of classes 
              const studentClasses = DataStore.getStudentClasses(student.id);
              const classNames = studentClasses.map(c => c.name).join(", ") || "Chưa đăng ký lớp";
  
              const statusClass = getStatusClass(student.status);
              const statusText = getStatusText(student.status);
  
              html += `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-shadow duration-300 border border-gray-200 dark:border-gray-700 overflow-hidden mb-4">
                    <div class="p-5">
                        <h4 class="font-bold text-lg mb-2 flex items-center">
                            <i class="fas fa-user-graduate text-primary-500 mr-2"></i>
                            ${student.name}
                        </h4>
                        <div class="text-gray-600 dark:text-gray-400 mb-3 space-y-1">
                            <p class="flex items-center"><i class="fas fa-graduation-cap w-5 mr-2 text-primary-400"></i> Khối: ${student.grade}</p>
                            <p class="flex items-center"><i class="fas fa-phone w-5 mr-2 text-primary-400"></i> SĐT: ${student.phone || "Chưa có"}</p>
                            <p class="flex items-center"><i class="fas fa-chalkboard-teacher w-5 mr-2 text-primary-400"></i> Lớp: ${classNames}</p>
                        </div>
                        <div class="flex items-center justify-between flex-wrap gap-3">
                            <span class="px-2 py-1 rounded-full text-sm font-medium ${statusClass}">
                                ${statusText}
                            </span>
                            ${
                              canPayFees
                                ? `<button onclick="UIController.showCollectFeeModal('${student.id}')" class="btn-hover-effect bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white py-2 px-4 rounded-lg transition-all duration-200 flex items-center shadow-sm">
                                    <i class="fas fa-money-bill-wave mr-2"></i> Thu học phí
                                    ${unpaidClasses.length > 1 ? `<span class="ml-1 px-1.5 py-0.5 bg-white/20 rounded-full text-xs">${unpaidClasses.length}</span>` : ''}
                                </button>`
                                : `<button disabled class="bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 py-2 px-4 rounded-lg cursor-not-allowed flex items-center">
                                    <i class="fas fa-check-circle mr-2"></i> Đã đóng đủ học phí
                                </button>`
                            }
                        </div>
                    </div>
                </div>
              `;
            });
  
            this.elements.feeStudentList.innerHTML = html;
            
            // Hide loading
            hideLoading();
        },

        showCollectFeeModal(studentId) {
          const student = DataStore.students.find((s) => s.id === studentId);
          if (!student) {
            showToast("Không tìm thấy học sinh", "error");
            return;
          }

          const unpaidClasses = DataStore.getUnpaidClasses(studentId);
          if (unpaidClasses.length === 0) {
            showToast("Học sinh này đã đóng đủ học phí", "info");
            return;
          }

          // Populate student info
          this.elements.feeStudentName.textContent = student.name;
          this.elements.feeStudentGrade.textContent = student.grade;
          this.elements.feeStudentPhone.textContent =
            student.phone || "Chưa có";

          // Populate classes list
          let html = "";
          
          // Sort classes by name for consistency
          const sortedClasses = [...unpaidClasses].sort((a, b) => 
            a.name.localeCompare(b.name, 'vi')
          );
          
          sortedClasses.forEach((classObj) => {
            html += `
                <div class="flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-750/50 transition-colors mb-2">
                    <input type="checkbox" id="feeClass${
                      classObj.id
                    }" value="${classObj.id}" data-fee="${
              classObj.fee
            }" class="fee-class-checkbox w-4 h-4 text-primary-600 accent-primary-600 rounded border-gray-300 focus:ring-primary-500 dark:border-gray-600 mr-3">
                    <label for="feeClass${
                      classObj.id
                    }" class="flex-grow cursor-pointer">
                        <div class="font-medium">${classObj.name} <span class="text-gray-500 dark:text-gray-400">(${
              classObj.grade
            })</span></div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Giáo viên: ${classObj.teacher}</div>
                    </label>
                    <span class="font-medium text-primary-600 dark:text-primary-400">${formatCurrency(
                      classObj.fee
                    )}</span>
                </div>
            `;
          });

          this.elements.feeClassesList.innerHTML = html;

          // Add event listeners to checkboxes
          const checkboxes = document.querySelectorAll(".fee-class-checkbox");
          checkboxes.forEach((checkbox) => {
            checkbox.addEventListener("change", () => this.updateFeeTotal());
          });
          
          // Check all checkboxes by default if less than 5 classes
          if (unpaidClasses.length <= 5) {
            checkboxes.forEach(checkbox => {
              checkbox.checked = true;
            });
          } else {
            // Only check the first class if many classes
            if (checkboxes.length > 0) {
              checkboxes[0].checked = true;
            }
          }

          // Initialize total
          this.updateFeeTotal();

          // Store student ID for later use
          this.elements.collectFeeModal.dataset.studentId = studentId;

          this.showModal("collectFeeModal");
        },

        updateFeeTotal() {
          const checkboxes = document.querySelectorAll(
            ".fee-class-checkbox:checked"
          );
          let total = 0;

          checkboxes.forEach((checkbox) => {
            total += parseInt(checkbox.dataset.fee || 0);
          });

          this.elements.feeTotalAmount.textContent = formatCurrency(total);
        },

        collectFee() {
          const studentId = this.elements.collectFeeModal.dataset.studentId;
          if (!studentId) {
            showToast("Lỗi: Không tìm thấy ID học sinh", "error");
            return;
          }

          const checkedBoxes = document.querySelectorAll(
            ".fee-class-checkbox:checked"
          );
          if (checkedBoxes.length === 0) {
            showToast("Vui lòng chọn ít nhất một lớp học để thu phí", "error");
            return;
          }

          // Show loading
          showLoading();
          
          const classIds = Array.from(checkedBoxes).map(
            (checkbox) => checkbox.value
          );

          DataStore.recordPayment(studentId, classIds)
            .then(transaction => {
            if (transaction) {
              showToast("Thu học phí thành công", "success");
              this.hideModal("collectFeeModal");
              this.showReceipt(transaction.id);
            } else {
              showToast("Lỗi khi thu học phí", "error");
            }
            hideLoading();
            })
            .catch(error => {
              console.error("Error collecting fee:", error);
              showToast("Lỗi khi thu học phí: " + error.message, "error");
              hideLoading();
            });
        },

        showReceipt(transactionId) {
          const transaction = DataStore.transactions.find(
            (t) => t.id === transactionId
          );
          if (!transaction) {
            showToast("Không tìm thấy giao dịch", "error");
            return;
          }

          const student = DataStore.students.find(
            (s) => s.id === transaction.studentId
          );
          if (!student) {
            showToast("Không tìm thấy thông tin học sinh", "error");
            return;
          }

          // Populate receipt
          this.elements.receiptId.textContent = transaction.id;
          this.elements.receiptDate.textContent = formatDate(transaction.date);
          this.elements.receiptStudentName.textContent = student.name;
          this.elements.receiptStudentGrade.textContent = student.grade;
          this.elements.receiptStudentPhone.textContent = student.phone || "-";

          // Populate class details
          let detailsHtml = "";
          let totalAmount = 0;
          
          // Sort class details by name for consistency
          const sortedClassDetails = [...transaction.classDetails].sort((a, b) => 
            a.className.localeCompare(b.className, 'vi')
          );
          
          sortedClassDetails.forEach((detail) => {
            totalAmount += parseInt(detail.fee || 0);
            detailsHtml += `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <td class="border border-gray-300 p-3">${
                      detail.className
                    }</td>
                    <td class="border border-gray-300 p-3">${
                      detail.teacherName
                    }</td>
                    <td class="border border-gray-300 p-3 text-right font-medium">${formatCurrency(
                      detail.fee
                    )}</td>
                </tr>
            `;
          });

          this.elements.receiptDetailsList.innerHTML = detailsHtml;
          this.elements.receiptTotal.textContent = formatCurrency(totalAmount);

          this.showModal("receiptModal");
        },

        printReceipt() {
          const receiptContent = this.elements.receiptContent;

          // Create a new window for printing
          const printWindow = window.open("", "_blank");

          // Add content to the new window
          printWindow.document.write(`
                    <html>
                    <head>
                        <title>Biên lai thu học phí</title>
                        <style>
                            body {
                                font-family: 'Segoe UI', Arial, sans-serif;
                                padding: 30px;
                                color: #333;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-bottom: 24px;
                            }
                            th, td {
                                border: 1px solid #ddd;
                                padding: 12px;
                            }
                            th {
                                background-color: #f5f7ff;
                                text-align: left;
                                font-weight: 600;
                            }
                            .text-center {
                                text-align: center;
                            }
                            .text-right {
                                text-align: right;
                            }
                            .mb-4 {
                                margin-bottom: 16px;
                            }
                            .mt-8 {
                                margin-top: 32px;
                            }
                            .flex {
                                display: flex;
                                justify-content: space-between;
                            }
                            .signature-block {
                                width: 45%;
                                text-align: center;
                            }
                            .signature-space {
                                height: 80px;
                            }
                            h1 {
                                text-align: center;
                                font-size: 26px;
                                margin-bottom: 24px;
                                color: #5D5CDE;
                                text-transform: uppercase;
                                letter-spacing: 1px;
                            }
                            .divider {
                                width: 80px;
                                height: 4px;
                                background-color: #5D5CDE;
                                margin: 0 auto 32px auto;
                            }
                            .customer-info {
                                background-color: #f9f9f9;
                                padding: 16px;
                                border-radius: 8px;
                                margin-bottom: 24px;
                            }
                            .receipt-header {
                                display: flex;
                                justify-content: space-between;
                                margin-bottom: 24px;
                            }
                            .receipt-id {
                                font-weight: bold;
                                color: #5D5CDE;
                            }
                            .section-title {
                                font-weight: bold;
                                margin-bottom: 12px;
                                color: #333;
                            }
                            .border-bottom {
                                border-bottom: 1px dashed #ddd;
                                padding-bottom: 8px;
                            }
                            .total-row {
                                font-weight: bold;
                                font-size: 18px;
                                background-color: #f5f7ff;
                            }
                        </style>
                    </head>
                    <body>
                        <h1>BIÊN LAI THU HỌC PHÍ</h1>
                        <div class="divider"></div>
                        
                        <div class="receipt-header">
                            <p><span class="receipt-id">Mã biên lai:</span> ${document.getElementById('receiptId').textContent}</p>
                            <p><span class="receipt-id">Ngày:</span> ${document.getElementById('receiptDate').textContent}</p>
                        </div>
                        
                        <div class="customer-info">
                            <p><strong>Học sinh:</strong> ${document.getElementById('receiptStudentName').textContent}</p>
                            <p><strong>Khối lớp:</strong> ${document.getElementById('receiptStudentGrade').textContent}</p>
                            <p><strong>Số điện thoại:</strong> ${document.getElementById('receiptStudentPhone').textContent}</p>
                        </div>
                        
                        <p class="section-title">Chi tiết học phí:</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Lớp học</th>
                                    <th>Giáo viên</th>
                                    <th style="text-align: right;">Học phí</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${document.getElementById('receiptDetailsList').innerHTML}
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="2" style="text-align: right;">Tổng cộng:</td>
                                    <td style="text-align: right;">${document.getElementById('receiptTotal').textContent}</td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div class="flex mt-8">
                            <div class="signature-block">
                                <p class="border-bottom">Người nộp tiền</p>
                                <p style="font-style: italic; color: #666;">(Ký, ghi rõ họ tên)</p>
                                <div class="signature-space"></div>
                            </div>
                            <div class="signature-block">
                                <p class="border-bottom">Người thu tiền</p>
                                <p style="font-style: italic; color: #666;">(Ký, ghi rõ họ tên)</p>
                                <div class="signature-space"></div>
                            </div>
                        </div>
                    </body>
                    </html>
                `);

          // Trigger print dialog
          printWindow.document.close();
          printWindow.focus();
          
          // Small delay to ensure content is loaded before printing
          setTimeout(() => {
            printWindow.print();
            printWindow.onafterprint = function () {
              printWindow.close();
            };
          }, 500);
        },

        showPrintStudentList() {
          const classId = this.elements.classDetailSection.dataset.classId;
          if (!classId) return;

          const classObj = DataStore.classes.find((c) => c.id === classId);
          if (!classObj) {
            showToast("Không tìm thấy lớp học", "error");
            return;
          }

          // Populate class info
          this.elements.printClassName.textContent = classObj.name;
          this.elements.printClassTeacher.textContent = classObj.teacher;
          this.elements.printClassSchedule.textContent =
            classObj.schedule || "-";

          // Get student details
          const students = DataStore.getClassStudentsDetails(classId);
          
          // Sort students by name for the print list
          const sortedStudents = [...students].sort((a, b) => a.name.localeCompare(b.name, 'vi'));

          // Populate student table
          let html = "";
          if (sortedStudents.length === 0) {
            html = `<tr><td colspan="6" class="border border-gray-300 p-3 text-center text-gray-500">Chưa có học sinh nào trong lớp này</td></tr>`;
          } else {
            sortedStudents.forEach((student, index) => {
              const statusClass = student.status === "đang học" 
                ? "text-green-600" 
                : student.status === "tạm nghỉ" 
                  ? "text-yellow-600" 
                  : "text-red-600";
              const statusText = getStatusText(student.status);

              html += `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50">
                    <td class="border border-gray-300 p-3 text-center">${
                      index + 1
                    }</td>
                    <td class="border border-gray-300 p-3 font-medium">${
                      student.name
                    }</td>
                    <td class="border border-gray-300 p-3">${
                      student.grade
                    }</td>
                    <td class="border border-gray-300 p-3">${
                      student.phone
                    }</td>
                    <td class="border border-gray-300 p-3 text-center ${statusClass}">
                        ${statusText}
                    </td>
                    <td class="border border-gray-300 p-3 text-center ${
                      student.isPaid ? "text-green-600" : "text-red-600"
                    }">
                        ${student.isPaid ? "Đã đóng" : "Chưa đóng"}
                    </td>
                </tr>
              `;
            });
          }

          this.elements.printStudentList.innerHTML = html;
          this.elements.printTotalStudents.textContent = sortedStudents.length;

          this.showModal("studentListPrintModal");
        },

        printStudentList() {
          const content = this.elements.studentListContent;

          // Create a new window for printing
          const printWindow = window.open("", "_blank");

          // Add content to the new window
          printWindow.document.write(`
                    <html>
                    <head>
                        <title>Danh sách học sinh</title>
                        <style>
                            body {
                                font-family: 'Segoe UI', Arial, sans-serif;
                                padding: 30px;
                                color: #333;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-bottom: 24px;
                            }
                            th, td {
                                border: 1px solid #ddd;
                                padding: 12px;
                            }
                            th {
                                background-color: #f5f7ff;
                                text-align: left;
                                font-weight: 600;
                            }
                            .text-center {
                                text-align: center;
                            }
                            .text-right {
                                text-align: right;
                            }
                            .mb-4 {
                                margin-bottom: 16px;
                            }
                            .mb-6 {
                                margin-bottom: 24px;
                            }
                            .mt-8 {
                                margin-top: 32px;
                            }
                            .flex {
                                display: flex;
                                justify-content: space-between;
                            }
                            .h-24 {
                                height: 96px;
                            }
                            h1 {
                                text-align: center;
                                font-size: 26px;
                                margin-bottom: 10px;
                                color: #5D5CDE;
                                text-transform: uppercase;
                                letter-spacing: 1px;
                            }
                            .divider {
                                width: 80px;
                                height: 4px;
                                background-color: #5D5CDE;
                                margin: 0 auto 24px auto;
                            }
                            .text-green-600 { color: #059669; }
                            .text-yellow-600 { color: #D97706; }
                            .text-red-600 { color: #DC2626; }
                            .class-info {
                                text-align: center;
                                margin-bottom: 24px;
                            }
                            .class-name {
                                font-size: 20px;
                                margin: 16px 0 8px 0;
                                color: #5D5CDE;
                            }
                            .teacher-info {
                                display: flex;
                                justify-content: center;
                                gap: 40px;
                                margin-bottom: 32px;
                            }
                            .footer-section {
                                margin-top: 40px;
                                text-align: right;
                            }
                            .signature-section {
                                margin-top: 24px;
                            }
                            .border-bottom {
                                border-bottom: 1px dashed #ddd;
                                padding-bottom: 8px;
                                margin-bottom: 8px;
                            }
                            .total-row {
                                font-weight: bold;
                                background-color: #f5f7ff;
                            }
                        </style>
                    </head>
                    <body>
                        <h1>DANH SÁCH HỌC SINH</h1>
                        <div class="divider"></div>
                        
                        <div class="class-info">
                            <p class="class-name">Lớp: ${document.getElementById('printClassName').textContent}</p>
                            <div class="teacher-info">
                                <p><strong>Giáo viên:</strong> ${document.getElementById('printClassTeacher').textContent}</p>
                                <p><strong>Lịch học:</strong> ${document.getElementById('printClassSchedule').textContent}</p>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th class="text-center">STT</th>
                                    <th>Họ và tên</th>
                                    <th>Khối</th>
                                    <th>Số điện thoại</th>
                                    <th class="text-center">Tình trạng</th>
                                    <th class="text-center">Trạng thái học phí</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${document.getElementById('printStudentList').innerHTML}
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="6" class="text-right">
                                        <strong>Tổng số học sinh:</strong>
                                        <span id="printTotalStudents">${document.getElementById('printTotalStudents').textContent}</span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div class="footer-section">
                            <p>Ngày _____ tháng _____ năm _____</p>
                            <div class="signature-section">
                                <p class="border-bottom">Người lập danh sách</p>
                                <p style="font-style: italic; color: #666;">(Ký, ghi rõ họ tên)</p>
                                <div style="height: 96px;"></div>
                            </div>
                        </div>
                    </body>
                    </html>
                `);

          // Trigger print dialog
          printWindow.document.close();
          printWindow.focus();
          
          // Small delay to ensure content is loaded before printing
          setTimeout(() => {
            printWindow.print();
            printWindow.onafterprint = function () {
              printWindow.close();
            };
          }, 500);
        },

        // Excel Export Methods
        exportClassStudentsToExcel() {
          const classId = this.elements.classDetailSection.dataset.classId;
          if (!classId) return;

          const classObj = DataStore.classes.find((c) => c.id === classId);
          if (!classObj) {
            showToast("Không tìm thấy lớp học", "error");
            return;
          }

          // Show loading
          showLoading();
          
          setTimeout(() => {
            // Get student details
            const students = DataStore.getClassStudentsDetails(classId);
            
            // Sort students by name for Excel export
            const sortedStudents = [...students].sort((a, b) => a.name.localeCompare(b.name, 'vi'));
  
            // Prepare data for Excel export
            const fileName = `DanhSachHocSinh_${classObj.name.replace(
              /\s+/g,
              "_"
            )}.xlsx`;
            const sheetName = "Danh sách học sinh";
  
            // Header information
            const headerData = [
              ["DANH SÁCH HỌC SINH"],
              [`Lớp: ${classObj.name}`],
              [`Giáo viên: ${classObj.teacher}`],
              [`Lịch học: ${classObj.schedule || "-"}`],
              [], // Empty row
            ];
  
            // Table headers
            const tableHeaders = [
              "STT",
              "Họ và tên",
              "Khối",
              "Số điện thoại",
              "Tình trạng",
              "Trạng thái học phí",
            ];
  
            // Prepare student data rows
            const studentData = sortedStudents.map((student, index) => [
              index + 1,
              student.name,
              student.grade,
              student.phone,
              getStatusText(student.status),
              student.isPaid ? "Đã đóng" : "Chưa đóng",
            ]);
  
            // Combine all data
            const data = [...headerData, tableHeaders, ...studentData];
  
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
  
            // Apply some styling (limited in this library)
            ws["!merges"] = [
              { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }, // Merge cells for title
            ];
  
            // Create workbook and add the worksheet
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
  
            // Generate Excel file
            const excelData = XLSX.write(wb, {
              bookType: "xlsx",
              type: "base64",
            });
  
            // Create and open a new window with the data
            const dataUrl =
              "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," +
              excelData;
            const newWindow = window.open(dataUrl);
  
            // Show instructions
            this.showModal("excelInstructionsModal");
  
            // Hide loading
            hideLoading();
          }, 1000);
        },

        exportAllStudentsToExcel() {
          // Show loading
          showLoading();
          
          setTimeout(() => {
            // Get all students
            const students = DataStore.getAllStudents();
  
            if (students.length === 0) {
              showToast("Không có học sinh nào để xuất", "error");
              hideLoading();
              return;
            }
            
            // Sort students by name for Excel export
            const sortedStudents = [...students].sort((a, b) => 
              a.name.localeCompare(b.name, 'vi')
            );
  
            // Prepare data for Excel export
            const fileName = "DanhSachHocSinh.xlsx";
            const sheetName = "Danh sách học sinh";
  
            // Header information
            const headerData = [
              ["DANH SÁCH HỌC SINH"],
              [], // Empty row
            ];
  
            // Table headers
            const tableHeaders = [
              "STT",
              "Họ và tên",
              "Khối",
              "Số điện thoại",
              "Tình trạng",
              "Lớp học đã đăng ký",
            ];
  
            // Prepare student data rows
            const studentData = sortedStudents.map((student, index) => [
              index + 1,
              student.name,
              student.grade,
              student.phone,
              getStatusText(student.status),
              student.classes,
            ]);
  
            // Combine all data
            const data = [...headerData, tableHeaders, ...studentData];
  
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
  
            // Apply some styling (limited in this library)
            ws["!merges"] = [
              { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }, // Merge cells for title
            ];
  
            // Create workbook and add the worksheet
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
  
            // Generate Excel file
            const excelData = XLSX.write(wb, {
              bookType: "xlsx",
              type: "base64",
            });
  
            // Create and open a new window with the data
            const dataUrl =
              "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," +
              excelData;
            const newWindow = window.open(dataUrl);
  
            // Show instructions
            this.showModal("excelInstructionsModal");
            
            // Hide loading
            hideLoading();
          }, 1000);
        },

        // Delete Confirmation Action
        confirmDelete() {
          // This method is empty because it's dynamically defined when showing confirmation dialog
        },
      };

      // Helper Functions
      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
          maximumFractionDigits: 0
        })
          .format(amount)
          .replace("₫", "VNĐ");
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("vi-VN");
      }

      function getStatusClass(status) {
        switch (status) {
          case "đang học":
            return "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300";
          case "tạm nghỉ":
            return "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300";
          case "đã nghỉ học":
            return "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300";
          default:
            return "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300";
        }
      }

      function getStatusText(status) {
        switch (status) {
          case "đang học":
            return "Đang học";
          case "tạm nghỉ":
            return "Tạm nghỉ";
          case "đã nghỉ học":
            return "Đã nghỉ học";
          default:
            return "Đang học";
        }
      }

      function showToast(message, type = "success") {
        const toast = document.getElementById("toastNotification");
        const toastMessage = document.getElementById("toastMessage");
        const toastIcon = document.getElementById("toastIcon");

        toastMessage.textContent = message;

        // Reset classes
        toast.classList.remove(
          "bg-green-500", "bg-red-500", "bg-blue-500", "bg-yellow-500",
          "dark:bg-green-600", "dark:bg-red-600", "dark:bg-blue-600", "dark:bg-yellow-600"
        );
        
        // Clear icon content
        toastIcon.innerHTML = '';

        // Set appropriate class based on type
        switch (type) {
          case "success":
            toast.classList.add("bg-green-500", "dark:bg-green-600");
            toastIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            break;
          case "error":
            toast.classList.add("bg-red-500", "dark:bg-red-600");
            toastIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            break;
          case "info":
            toast.classList.add("bg-blue-500", "dark:bg-blue-600");
            toastIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
            break;
          case "warning":
            toast.classList.add("bg-yellow-500", "dark:bg-yellow-600");
            toastIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            break;
        }

        // Show toast
        toast.classList.remove("translate-y-20", "opacity-0");

        // Hide toast after 3 seconds
        setTimeout(() => {
          toast.classList.add("translate-y-20", "opacity-0");
        }, 3000);
      }

      function showLoading() {
        document.getElementById("loadingOverlay").classList.remove("hidden");
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.add("hidden");
      }

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize Firebase auth and data stores
        AuthManager.init();
        DataStore.init();
        UIController.init();
      });
    </script>
  </body>
</html>
